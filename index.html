<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Call Center & Delivery Dashboard (Period Reports)</title>
<style>
:root {
  --primary: #2563eb;
  --primary-dark: #1e40af;
  --secondary: #64748b;
  --bg: #f3f4f6;
  --surface: #ffffff;
  --text-main: #1f2937;
  --text-light: #6b7280;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --border: #e5e7eb;
  --radius: 8px;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

* { box-sizing: border-box; }

body {
  font-family: system-ui, -apple-system, sans-serif;
  margin: 0;
  padding: 0;
  background-color: var(--bg);
  color: var(--text-main);
  line-height: 1.5;
}

/* Layout */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 10px;
}

h1 { margin: 0; font-size: 1.5rem; color: var(--text-main); }
h2 { font-size: 1.25rem; margin-bottom: 15px; color: var(--text-main); border-bottom: 2px solid var(--border); padding-bottom: 8px; }

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border: none;
  border-radius: var(--radius);
  cursor: pointer;
  font-weight: 500;
  font-size: 0.9rem;
  transition: all 0.2s;
  background-color: var(--primary);
  color: white;
}
.btn:hover { background-color: var(--primary-dark); }
.btn-secondary { background-color: white; color: var(--text-main); border: 1px solid var(--border); }
.btn-secondary:hover { background-color: var(--bg); }
.btn-danger { background-color: var(--danger); }
.btn-danger:hover { background-color: #dc2626; }
.btn-sm { padding: 4px 8px; font-size: 0.8rem; }

/* Period Selector (Tabs) */
.period-selector {
  display: flex;
  gap: 5px;
  background: #e2e8f0;
  padding: 4px;
  border-radius: var(--radius);
  margin-bottom: 20px;
}
.period-btn {
  padding: 6px 12px;
  border: none;
  background: transparent;
  cursor: pointer;
  border-radius: 4px;
  font-size: 0.9rem;
  color: var(--text-light);
  font-weight: 500;
}
.period-btn.active {
  background: white;
  color: var(--primary);
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* Dashboard Cards */
.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.card {
  background: var(--surface);
  padding: 20px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border-left: 4px solid var(--primary);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.card h3 { margin: 0 0 10px 0; font-size: 0.85rem; text-transform: uppercase; color: var(--text-light); letter-spacing: 0.5px; }
.card .value { font-size: 1.8rem; font-weight: 700; color: var(--text-main); }
.card .indicator { font-size: 0.85rem; margin-top: 5px; }

/* Chart Section */
.chart-section {
  background: var(--surface);
  padding: 20px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 24px;
}
.chart-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 15px;
}
.bar-group {
  display: flex;
  align-items: center;
  gap: 10px;
}
.bar-label { width: 100px; font-size: 0.9rem; text-align: right; color: var(--text-light); }
.bar-track { flex: 1; background: var(--bg); height: 24px; border-radius: 12px; overflow: hidden; position: relative; }
.bar-fill { height: 100%; border-radius: 12px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.75rem; font-weight: bold; }
.fill-received { background-color: var(--primary); }
.fill-delivered { background-color: var(--success); }

/* Controls & Filters */
.controls {
  background: var(--surface);
  padding: 15px 20px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 24px;
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  align-items: center;
}
.controls input, .controls select {
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  font-size: 0.9rem;
}

/* Tables */
.table-container {
  background: var(--surface);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow-x: auto;
  margin-bottom: 30px;
}
table { width: 100%; border-collapse: collapse; min-width: 800px; }
th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
th { background-color: #f8fafc; color: var(--text-light); font-weight: 600; cursor: pointer; user-select: none; }
th:hover { background-color: #e2e8f0; }
tr:hover { background-color: #f9fafb; }
.badge { padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
.bg-green { background-color: #dcfce7; color: #166534; }
.bg-yellow { background-color: #fef3c7; color: #92400e; }
.bg-red { background-color: #fee2e2; color: #991b1b; }
.money-text { font-family: 'Courier New', Courier, monospace; font-weight: 600; color: var(--text-main); }

/* Modal */
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex; justify-content: center; align-items: center;
  z-index: 1000;
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s;
}
.modal-overlay.active { opacity: 1; pointer-events: auto; }
.modal {
  background: var(--surface);
  padding: 24px;
  border-radius: var(--radius);
  width: 100%;
  max-width: 500px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  transform: translateY(20px);
  transition: transform 0.3s;
}
.modal-overlay.active .modal { transform: translateY(0); }
.modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
.modal-body { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.modal-body .full-width { grid-column: span 2; }
.form-group label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--text-light); }
.form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; }
.modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }

/* Toast */
#toast {
  visibility: hidden;
  min-width: 250px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 4px;
  padding: 12px;
  position: fixed;
  z-index: 2000;
  left: 50%;
  bottom: 30px;
  transform: translateX(-50%);
  font-size: 0.9rem;
}
#toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

@keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
@keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

/* Responsive */
@media (max-width: 600px) {
  .modal-body { grid-template-columns: 1fr; }
  .controls { flex-direction: column; align-items: stretch; }
  .btn { width: 100%; justify-content: center; }
  header { flex-direction: column; align-items: stretch; }
  .header-actions { display: flex; gap: 10px; }
  .period-selector { flex-wrap: wrap; }
}
</style>
</head>
<body>

<div class="container">
  <header>
    <div>
      <h1 id="reportTitle">Dashboard Overview</h1>
      <p style="color: var(--text-light); margin: 0;">Call Center & Delivery Analytics</p>
    </div>
    <div class="header-actions">
      <button class="btn" onclick="openModal()">+ Add Entry</button>
      <button class="btn btn-secondary" onclick="exportToCSV()">Export CSV</button>
      <button class="btn btn-secondary" onclick="window.print()">Print</button>
    </div>
  </header>

  <!-- Period Selector -->
  <div class="period-selector">
    <button class="period-btn" onclick="setPeriod('all')" id="btn-all">All Time</button>
    <button class="period-btn" onclick="setPeriod('monthly')" id="btn-monthly">This Month</button>
    <button class="period-btn" onclick="setPeriod('weekly')" id="btn-weekly">This Week</button>
    <button class="period-btn active" onclick="setPeriod('daily')" id="btn-daily">Today</button>
  </div>

  <!-- KPI Cards -->
  <div class="dashboard">
    <div class="card" style="border-left-color: #3b82f6;">
      <h3>Total Orders</h3>
      <div class="value" id="totalOrdersCC">0</div>
    </div>
    <div class="card" style="border-left-color: #f59e0b;">
      <h3>Picked Up</h3>
      <div class="value" id="totalPickedUp">0</div>
    </div>
    <div class="card" style="border-left-color: #10b981;">
      <h3>Delivered</h3>
      <div class="value" id="totalDelivered">0</div>
    </div>
    <div class="card" style="border-left-color: #8b5cf6;">
      <h3>Total Tips</h3>
      <div class="value" id="totalTips">$0.00</div>
    </div>
    <div class="card" style="border-left-color: #6366f1;">
      <h3>Success Rate</h3>
      <div class="value" id="deliveryRate">0%</div>
      <div class="indicator" id="rateIndicator">-</div>
    </div>
    <div class="card" style="border-left-color: #ef4444;">
      <h3>Variance</h3>
      <div class="value" id="totalDifference">0</div>
    </div>
  </div>

  <!-- Visual Chart -->
  <div class="chart-section">
    <h2 id="chartTitle">Performance Overview</h2>
    <div id="chartContainer" class="chart-container">
      <!-- Bars injected via JS -->
    </div>
  </div>

  <!-- Filters (Date filter is less useful with Periods, but kept for manual search) -->
  <div class="controls">
    <div style="flex: 1;">
      <label style="font-size: 0.85rem; font-weight: 600; margin-right: 8px;">Filter Branch:</label>
      <select id="filterBranch" onchange="renderAll()">
        <option value="">All Branches</option>
        <option>Hamdan St</option>
        <option>Al Khalidiyah</option>
        <option>Shabiya 11</option>
        <option>Muroor</option>
        <option>Al Majaz</option>
        <option>Al Barsha</option>
        <option>Al Satwa</option>
        <option>Al Rigga</option>
      </select>
    </div>
  </div>

  <!-- Data Tables Area -->
  <div id="branchTables"></div>
</div>

<!-- Modal Form -->
<div class="modal-overlay" id="entryModal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">Add New Entry</h3>
      <button class="btn btn-secondary btn-sm" style="border:none; font-size:1.2rem;" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editIndex">
      <div class="form-group full-width">
        <label>Date</label>
        <input type="date" id="entryDate">
      </div>
      <div class="form-group full-width">
        <label>Branch</label>
        <select id="branchSelect">
          <option>Hamdan St</option>
          <option>Al Khalidiyah</option>
          <option>Shabiya 11</option>
          <option>Muroor</option>
          <option>Al Majaz</option>
          <option>Al Barsha</option>
          <option>Al Satwa</option>
          <option>Al Rigga</option>
        </select>
      </div>
      <div class="form-group">
        <label>Orders Received (CC)</label>
        <input type="number" id="ordersReceived" min="0">
      </div>
      <div class="form-group">
        <label>Picked Up (CC)</label>
        <input type="number" id="pickedUp" min="0">
      </div>
      <div class="form-group">
        <label>Cancelled (CC)</label>
        <input type="number" id="cancelledCC" min="0">
      </div>
      <div class="form-group">
        <label>Delivered (DL)</label>
        <input type="number" id="ordersDelivered" min="0">
      </div>
      <div class="form-group full-width">
        <label>Tip Amount ($)</label>
        <input type="number" id="tipAmount" min="0" step="0.01" placeholder="0.00">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn" onclick="saveEntry()">Save Entry</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h3 style="color: var(--danger)">Confirm Delete</h3>
    </div>
    <div class="modal-body" style="grid-template-columns: 1fr;">
      <p>Are you sure you want to delete this record? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast">Message here</div>

<script>
// --- State Management ---
let data = JSON.parse(localStorage.getItem('ccData')) || [];
let deleteIndexTarget = null;
let sortConfig = { key: 'date', direction: 'desc' };
let currentPeriod = 'daily'; // 'daily', 'weekly', 'monthly', 'all'

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
  setPeriod('daily'); // Default to Daily view
  document.getElementById('entryDate').valueAsDate = new Date();
});

// --- Core Logic ---

function calculateDifference(entry) {
  const expected = entry.ordersReceived - entry.pickedUp - entry.cancelledCC;
  return entry.delivered - expected;
}

function saveData() {
  localStorage.setItem('ccData', JSON.stringify(data));
  renderAll();
}

function saveEntry() {
  const index = document.getElementById('editIndex').value;
  const tipVal = parseFloat(document.getElementById('tipAmount').value);
  
  const entry = {
    date: document.getElementById('entryDate').value,
    branch: document.getElementById('branchSelect').value,
    ordersReceived: parseInt(document.getElementById('ordersReceived').value) || 0,
    pickedUp: parseInt(document.getElementById('pickedUp').value) || 0,
    cancelledCC: parseInt(document.getElementById('cancelledCC').value) || 0,
    delivered: parseInt(document.getElementById('ordersDelivered').value) || 0,
    tipAmount: isNaN(tipVal) ? 0 : tipVal
  };

  if(!entry.date) {
    showToast("Please select a date");
    return;
  }

  if (index === "") {
    entry.difference = calculateDifference(entry);
    data.push(entry);
    showToast("Entry added successfully");
  } else {
    entry.difference = calculateDifference(entry);
    data[index] = entry;
    showToast("Entry updated successfully");
  }

  saveData();
  closeModal();
}

// --- Period Logic ---

function setPeriod(period) {
  currentPeriod = period;
  
  // Update UI buttons
  document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById('btn-' + period).classList.add('active');

  // Update Title
  const titleMap = {
    'daily': 'Daily Report',
    'weekly': 'Weekly Report (Current Week)',
    'monthly': 'Monthly Report (Current Month)',
    'all': 'All Time Report'
  };
  document.getElementById('reportTitle').innerText = titleMap[period];
  document.getElementById('chartTitle').innerText = titleMap[period] + " Overview";

  renderAll();
}

function getFilteredData() {
  const now = new Date();
  
  return data.filter(entry => {
    const entryDate = new Date(entry.date + 'T00:00:00'); // Avoid timezone issues
    
    if (currentPeriod === 'daily') {
      // Check if same day
      return entryDate.toDateString() === now.toDateString();
    }
    
    if (currentPeriod === 'weekly') {
      // Calculate start of week (Sunday)
      const day = now.getDay(); 
      const diff = now.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
      const firstDayOfWeek = new Date(now.setDate(diff));
      firstDayOfWeek.setHours(0,0,0,0);
      
      return entryDate >= firstDayOfWeek && entryDate <= now;
    }
    
    if (currentPeriod === 'monthly') {
      // Check same month and year
      return entryDate.getMonth() === now.getMonth() && 
             entryDate.getFullYear() === now.getFullYear();
    }
    
    return true; // All time
  });
}

// --- Rendering ---

function renderAll() {
  // 1. Get data based on Period
  let periodData = getFilteredData();

  // 2. Further filter by Branch (from dropdown)
  const branchFilter = document.getElementById('filterBranch').value;
  if(branchFilter) {
    periodData = periodData.filter(d => d.branch === branchFilter);
  }

  updateDashboard(periodData);
  renderTables(periodData);
  renderChart(periodData);
}

function updateDashboard(dataset) {
  let totalCC = 0, totalPicked = 0, totalDelivered = 0, totalDiff = 0, totalTips = 0;
  
  dataset.forEach(entry => {
    totalCC += entry.ordersReceived;
    totalPicked += entry.pickedUp;
    totalDelivered += entry.delivered;
    totalDiff += entry.difference;
    totalTips += (entry.tipAmount || 0);
  });

  document.getElementById('totalOrdersCC').innerText = totalCC.toLocaleString();
  document.getElementById('totalPickedUp').innerText = totalPicked.toLocaleString();
  document.getElementById('totalDelivered').innerText = totalDelivered.toLocaleString();
  document.getElementById('totalTips').innerText = '$' + totalTips.toFixed(2);
  
  const diffElem = document.getElementById('totalDifference');
  diffElem.innerText = (totalDiff > 0 ? '+' : '') + totalDiff.toLocaleString();
  diffElem.style.color = totalDiff === 0 ? 'var(--text-main)' : (totalDiff < 0 ? 'var(--danger)' : 'var(--success)');

  const deliveryRate = totalCC > 0 ? ((totalDelivered / totalCC) * 100) : 0;
  const rateElem = document.getElementById('deliveryRate');
  rateElem.innerText = deliveryRate.toFixed(1) + '%';
  
  const indicator = document.getElementById('rateIndicator');
  if(deliveryRate >= 90) {
    indicator.innerText = "Excellent";
    indicator.className = "indicator bg-green";
  } else if (deliveryRate >= 75) {
    indicator.innerText = "Good";
    indicator.className = "indicator bg-yellow";
  } else {
    indicator.innerText = "Needs Attention";
    indicator.className = "indicator bg-red";
  }
}

function renderChart(dataset) {
  const container = document.getElementById('chartContainer');
  container.innerHTML = '';
  const branchStats = {};
  dataset.forEach(e => {
    if(!branchStats[e.branch]) branchStats[e.branch] = { received: 0, delivered: 0 };
    branchStats[e.branch].received += e.ordersReceived;
    branchStats[e.branch].delivered += e.delivered;
  });
  let maxVal = 0;
  Object.values(branchStats).forEach(stat => { if(stat.received > maxVal) maxVal = stat.received; });

  Object.keys(branchStats).sort().forEach(branch => {
    const stat = branchStats[branch];
    const recWidth = (stat.received / maxVal) * 100;
    const delWidth = (stat.delivered / maxVal) * 100;
    const html = `
    <div class="bar-group">
      <div class="bar-label">${branch}</div>
      <div class="bar-track">
        <div class="bar-fill fill-received" style="width: ${recWidth}%;" title="Received: ${stat.received}"></div>
        <div class="bar-fill fill-delivered" style="width: ${delWidth}%; margin-top: 26px;" title="Delivered: ${stat.delivered}"></div>
      </div>
      <div style="font-size: 0.75rem; width: 80px; color: var(--text-light);">
        <div>R: ${stat.received}</div>
        <div style="color: var(--success); font-weight:bold;">D: ${stat.delivered}</div>
      </div>
    </div>`;
    container.innerHTML += html;
  });
  
  if(Object.keys(branchStats).length === 0) {
    container.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:20px;">No data available for this period.</div>';
  }
}

function renderTables(dataset) {
  const container = document.getElementById('branchTables');
  container.innerHTML = '';

  // Sort data
  let sortedData = [...dataset]; // copy array to avoid mutating original
  sortedData.sort((a, b) => {
    let valA = a[sortConfig.key];
    let valB = b[sortConfig.key];
    if (typeof valA === 'string') valA = valA.toLowerCase();
    if (typeof valB === 'string') valB = valB.toLowerCase();
    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
    return 0;
  });

  const branches = [...new Set(sortedData.map(d => d.branch))];

  if (branches.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding: 40px; color: var(--text-light);">No records found for this report period.</div>';
    return;
  }

  branches.forEach(branch => {
    const branchData = sortedData.filter(d => d.branch === branch);
    
    let rowsHtml = branchData.map((entry, idx) => {
      // Find original index in main array for actions
      const originalIndex = data.indexOf(entry);
      
      let diffClass = 'bg-green';
      if(entry.difference !== 0) diffClass = Math.abs(entry.difference) <= 2 ? 'bg-yellow' : 'bg-red';
      const tipDisplay = (entry.tipAmount || 0).toFixed(2);

      return `
      <tr>
        <td>${entry.date}</td>
        <td>${entry.ordersReceived}</td>
        <td>${entry.pickedUp}</td>
        <td>${entry.cancelledCC}</td>
        <td>${entry.delivered}</td>
        <td class="money-text">$${tipDisplay}</td>
        <td><span class="badge ${diffClass}">${entry.difference > 0 ? '+' : ''}${entry.difference}</span></td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="editEntry(${originalIndex})">Edit</button>
          <button class="btn btn-danger btn-sm" onclick="confirmDelete(${originalIndex})">Delete</button>
        </td>
      </tr>`;
    }).join('');

    const section = document.createElement('div');
    section.className = 'table-container';
    section.style.marginBottom = '30px';
    section.innerHTML = `
      <div style="padding: 15px; border-bottom: 1px solid var(--border); background: #f8fafc;">
        <h3 style="margin:0; color: var(--primary);">${branch}</h3>
      </div>
      <table>
        <thead>
          <tr>
            <th onclick="sortTable('date')">Date &#8645;</th>
            <th onclick="sortTable('ordersReceived')">Received &#8645;</th>
            <th onclick="sortTable('pickedUp')">Picked Up &#8645;</th>
            <th onclick="sortTable('cancelledCC')">Cancelled &#8645;</th>
            <th onclick="sortTable('delivered')">Delivered &#8645;</th>
            <th onclick="sortTable('tipAmount')">Tip Amount &#8645;</th>
            <th onclick="sortTable('difference')">Diff &#8645;</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
      </table>
    `;
    container.appendChild(section);
  });
}

// --- Interaction Functions ---

function sortTable(key) {
  if (sortConfig.key === key) {
    sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
  } else {
    sortConfig.key = key;
    sortConfig.direction = 'desc';
  }
  renderAll();
}

function openModal() {
  document.getElementById('modalTitle').innerText = "Add New Entry";
  document.getElementById('editIndex').value = "";
  document.getElementById('entryDate').valueAsDate = new Date();
  document.getElementById('ordersReceived').value = '';
  document.getElementById('pickedUp').value = '';
  document.getElementById('cancelledCC').value = '';
  document.getElementById('ordersDelivered').value = '';
  document.getElementById('tipAmount').value = '';
  document.getElementById('entryModal').classList.add('active');
}

function editEntry(index) {
  const entry = data[index];
  document.getElementById('modalTitle').innerText = "Edit Entry";
  document.getElementById('editIndex').value = index;
  document.getElementById('entryDate').value = entry.date;
  document.getElementById('branchSelect').value = entry.branch;
  document.getElementById('ordersReceived').value = entry.ordersReceived;
  document.getElementById('pickedUp').value = entry.pickedUp;
  document.getElementById('cancelledCC').value = entry.cancelledCC;
  document.getElementById('ordersDelivered').value = entry.delivered;
  document.getElementById('tipAmount').value = entry.tipAmount || '';
  document.getElementById('entryModal').classList.add('active');
}

function closeModal() {
  document.getElementById('entryModal').classList.remove('active');
}

function confirmDelete(index) {
  deleteIndexTarget = index;
  document.getElementById('deleteModal').classList.add('active');
}

function closeDeleteModal() {
  deleteIndexTarget = null;
  document.getElementById('deleteModal').classList.remove('active');
}

document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
  if (deleteIndexTarget !== null) {
    data.splice(deleteIndexTarget, 1);
    saveData();
    showToast("Entry deleted successfully");
    closeDeleteModal();
  }
});

function showToast(message) {
  const x = document.getElementById("toast");
  x.className = "show";
  x.innerText = message;
  setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
}

function exportToCSV() {
  // Export only the visible data based on period and filters
  const visibleData = getFilteredData();
  const branchFilter = document.getElementById('filterBranch').value;
  let exportData = branchFilter ? visibleData.filter(d => d.branch === branchFilter) : visibleData;

  if(exportData.length === 0) {
    showToast("No data to export");
    return;
  }
  
  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += "Report Period," + currentPeriod.toUpperCase() + "\n";
  csvContent += "Date,Branch,Orders Received,Picked Up,Cancelled,Delivered,Tip Amount,Difference\n";
  
  exportData.forEach(e => {
    const row = `${e.date},${e.branch},${e.ordersReceived},${e.pickedUp},${e.cancelledCC},${e.delivered},${e.tipAmount || 0},${e.difference}`;
    csvContent += row + "\n";
  });
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `report_${currentPeriod}_${new Date().toISOString().slice(0,10)}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>

</body>
</html>
