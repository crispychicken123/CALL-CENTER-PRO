<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crispy Chicken - Compensation Tracking System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #e63946;
            --secondary-color: #f1faee;
            --accent-color: #a8dadc;
            --dark-color: #1d3557;
            --light-color: #f8f9fa;
            --whatsapp-color: #25D366;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-color);
            color: #333;
            line-height: 1.6;
        }
        
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: bold;
            color: white !important;
            display: flex;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .nav-tabs .nav-link {
            color: var(--dark-color);
            border: 1px solid #dee2e6;
            margin-bottom: -1px;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .nav-tabs .nav-link:hover:not(.active) {
            background-color: rgba(230, 57, 70, 0.1);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: none;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .stat-card {
            border-left: 5px solid var(--primary-color);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #d62828;
            border-color: #d62828;
            transform: translateY(-1px);
        }
        
        .btn-whatsapp {
            background-color: var(--whatsapp-color);
            border-color: var(--whatsapp-color);
            color: white;
            transition: all 0.3s;
        }
        
        .btn-whatsapp:hover {
            background-color: #128C7E;
            border-color: #128C7E;
            color: white;
            transform: translateY(-1px);
        }
        
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 5px;
        }
        
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .filter-section {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        .status-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .status-open { background-color: var(--warning-color); color: #212529; }
        .status-pending { background-color: var(--info-color); color: white; }
        .status-approved { background-color: var(--success-color); color: white; }
        .status-rejected { background-color: var(--danger-color); color: white; }
        .status-closed { background-color: #6c757d; color: white; }
        .status-manager-review { background-color: #6f42c1; color: white; }
        
        .footer {
            background-color: var(--dark-color);
            color: white;
            padding: 30px 0;
            margin-top: 40px;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .custom-toast {
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
            background-color: #fafafa;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(230, 57, 70, 0.05);
        }
        
        .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: rgba(230, 57, 70, 0.1);
            transform: scale(1.02);
        }
        
        .whatsapp-preview {
            background-color: #e5ddd5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .whatsapp-preview::before {
            content: '';
            position: absolute;
            top: 10px;
            left: -10px;
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid #e5ddd5;
        }
        
        .whatsapp-message {
            background-color: white;
            padding: 10px 15px;
            border-radius: 7.5px;
            margin-bottom: 10px;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            word-wrap: break-word;
        }
        
        .whatsapp-timestamp {
            font-size: 0.75rem;
            color: #667781;
            text-align: right;
            margin-top: 5px;
        }
        
        .manager-settings {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .dynamic-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .dynamic-input-group input {
            flex: 1;
        }
        
        .dynamic-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            background-color: white;
        }
        
        .dynamic-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .dynamic-list-item:hover {
            background-color: #f8f9fa;
        }
        
        .dynamic-list-item:last-child {
            border-bottom: none;
        }
        
        .dynamic-list-item button {
            padding: 2px 8px;
            font-size: 0.8rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(230, 57, 70, 0.25);
        }
        
        .btn {
            border-radius: 5px;
            font-weight: 500;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(230, 57, 70, 0.05);
        }
        
        .modal-content {
            border-radius: 10px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }
        
        .invalid-feedback {
            display: none;
            color: var(--danger-color);
            font-size: 0.875em;
            margin-top: 0.25rem;
        }
        
        .is-invalid ~ .invalid-feedback {
            display: block;
        }
        
        .is-invalid {
            border-color: var(--danger-color);
        }
        
        .channel-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 0.25rem;
            margin-right: 0.25rem;
        }
        
        .channel-platform {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .channel-call {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .channel-online {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
            
            .stat-card {
                margin-bottom: 15px;
            }
            
            .table-container {
                max-height: 400px;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .export-buttons .btn {
                width: 100%;
            }
        }
        
        @media (max-width: 576px) {
            .navbar-brand {
                font-size: 1rem;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .table {
                font-size: 0.875rem;
            }
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            body {
                background-color: white !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" aria-label="Crispy Chicken Home">
                <span class="logo" aria-hidden="true">üçó</span> 
                <span>Crispy Chicken - Compensation Tracking</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="dataCount" aria-label="Total cases count">Total Cases: 0</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="lastUpdated" aria-label="Last updated time">Last Updated: Never</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-4">
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist" aria-label="Main navigation tabs">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                    <i class="bi bi-speedometer2" aria-hidden="true"></i> Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="newCase-tab" data-bs-toggle="tab" data-bs-target="#newCase" type="button" role="tab" aria-controls="newCase" aria-selected="false">
                    <i class="bi bi-plus-circle" aria-hidden="true"></i> New Case
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cases-tab" data-bs-toggle="tab" data-bs-target="#cases" type="button" role="tab" aria-controls="cases" aria-selected="false">
                    <i class="bi bi-list-ul" aria-hidden="true"></i> All Cases
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="channels-tab" data-bs-toggle="tab" data-bs-target="#channels" type="button" role="tab" aria-controls="channels" aria-selected="false">
                    <i class="bi bi-telephone" aria-hidden="true"></i> Channels
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button" role="tab" aria-controls="import" aria-selected="false">
                    <i class="bi bi-upload" aria-hidden="true"></i> Import/Export
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="whatsapp-tab" data-bs-toggle="tab" data-bs-target="#whatsapp" type="button" role="tab" aria-controls="whatsapp" aria-selected="false">
                    <i class="bi bi-whatsapp" aria-hidden="true"></i> WhatsApp
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">
                    <i class="bi bi-gear" aria-hidden="true"></i> Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">
                    <i class="bi bi-file-earmark-bar-graph" aria-hidden="true"></i> Reports
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="row mt-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="card stat-card fade-in">
                            <div class="card-body">
                                <h5 class="card-title">Total Cases (Month)</h5>
                                <h2 class="text-primary" id="totalCasesMonth" aria-live="polite">0</h2>
                                <small class="text-muted" id="currentMonthLabel">This month</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card stat-card fade-in">
                            <div class="card-body">
                                <h5 class="card-title">Total Compensation</h5>
                                <h2 class="text-success" id="totalCompensation" aria-live="polite">AED 0</h2>
                                <small class="text-muted">All time</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card stat-card fade-in">
                            <div class="card-body">
                                <h5 class="card-title">Open Cases</h5>
                                <h2 class="text-warning" id="openCases" aria-live="polite">0</h2>
                                <small class="text-muted">Pending resolution</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card stat-card fade-in">
                            <div class="card-body">
                                <h5 class="card-title">Resolution Rate</h5>
                                <h2 class="text-info" id="resolutionRate" aria-live="polite">0%</h2>
                                <small class="text-muted">Last 30 days</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5>Cases by Channel</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="channelChart" aria-label="Cases by channel chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5>Cases by Platform</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="platformChart" aria-label="Cases by platform chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5>Cases by Branch</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="branchChart" aria-label="Cases by branch chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5>Status Breakdown</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="statusChart" aria-label="Status breakdown chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5>Top Issue Types</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="issueTypeChart" aria-label="Top issue types chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5>Agent Performance</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="table table-striped" aria-label="Agent performance table">
                                        <thead>
                                            <tr>
                                                <th>Agent Name</th>
                                                <th>Cases Handled</th>
                                                <th>Resolution Rate</th>
                                                <th>Avg. Resolution Time</th>
                                            </tr>
                                        </thead>
                                        <tbody id="agentPerformanceTable">
                                            <tr>
                                                <td colspan="4" class="text-center">No data available</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Case Tab -->
            <div class="tab-pane fade" id="newCase" role="tabpanel" aria-labelledby="newCase-tab">
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Register New Compensation Case</h5>
                    </div>
                    <div class="card-body">
                        <form id="newCaseForm" novalidate>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="caseId" class="form-label">Case ID</label>
                                    <input type="text" class="form-control" id="caseId" readonly aria-describedby="caseIdHelp">
                                    <div class="form-text" id="caseIdHelp">Auto-generated unique identifier</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="date" class="form-label">Date of Incident <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="date" required aria-describedby="dateHelp dateError">
                                    <div class="invalid-feedback" id="dateError">Please select a date</div>
                                    <div class="form-text" id="dateHelp">Select the date when the incident occurred</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="channel" class="form-label">Channel <span class="text-danger">*</span></label>
                                    <select class="form-select" id="channel" required aria-describedby="channelError">
                                        <option value="">Select Channel</option>
                                    </select>
                                    <div class="invalid-feedback" id="channelError">Please select a channel</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="platform" class="form-label">Platform <span class="text-danger">*</span></label>
                                    <select class="form-select" id="platform" required aria-describedby="platformError">
                                        <option value="">Select Platform</option>
                                    </select>
                                    <div class="invalid-feedback" id="platformError">Please select a platform</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="branch" class="form-label">Branch <span class="text-danger">*</span></label>
                                    <select class="form-select" id="branch" required aria-describedby="branchError">
                                        <option value="">Select Branch</option>
                                    </select>
                                    <div class="invalid-feedback" id="branchError">Please select a branch</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="orderNumber" class="form-label">Order Number <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="orderNumber" required aria-describedby="orderNumberError">
                                    <div class="invalid-feedback" id="orderNumberError">Please enter an order number</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="customerName" class="form-label">Customer Name / Number <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="customerName" required aria-describedby="customerNameError">
                                    <div class="invalid-feedback" id="customerNameError">Please enter customer name or number</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="issueType" class="form-label">Issue Type <span class="text-danger">*</span></label>
                                    <select class="form-select" id="issueType" required aria-describedby="issueTypeError">
                                        <option value="">Select Issue Type</option>
                                    </select>
                                    <div class="invalid-feedback" id="issueTypeError">Please select an issue type</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="responsibleParty" class="form-label">Responsible Party <span class="text-danger">*</span></label>
                                    <select class="form-select" id="responsibleParty" required aria-describedby="responsiblePartyError">
                                        <option value="">Select Responsible Party</option>
                                        <option value="Platform">Platform</option>
                                        <option value="Restaurant">Restaurant</option>
                                        <option value="Driver">Driver</option>
                                        <option value="Call Center">Call Center</option>
                                    </select>
                                    <div class="invalid-feedback" id="responsiblePartyError">Please select a responsible party</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="agentName" class="form-label">Agent Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="agentName" required aria-describedby="agentNameError">
                                    <div class="invalid-feedback" id="agentNameError">Please enter agent name</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="orderValue" class="form-label">Order Value (AED) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="orderValue" min="0" step="0.01" required aria-describedby="orderValueError">
                                    <div class="invalid-feedback" id="orderValueError">Please enter a valid order value</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="compensationValue" class="form-label">Compensation Value (AED) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="compensationValue" min="0" step="0.01" required aria-describedby="compensationValueError">
                                    <div class="invalid-feedback" id="compensationValueError">Please enter a valid compensation value</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                                    <select class="form-select" id="status" required aria-describedby="statusError">
                                        <option value="Open">Open</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Manager Review">Manager Review</option>
                                        <option value="Approved">Approved</option>
                                        <option value="Rejected">Rejected</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                    <div class="invalid-feedback" id="statusError">Please select a status</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="callReference" class="form-label">Call Reference (if applicable)</label>
                                    <input type="text" class="form-control" id="callReference" placeholder="Enter call reference number" aria-describedby="callReferenceHelp">
                                    <div class="form-text" id="callReferenceHelp">For call center channels only</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="actionTaken" class="form-label">Action Taken</label>
                                    <textarea class="form-control" id="actionTaken" rows="3" aria-describedby="actionTakenHelp"></textarea>
                                    <div class="form-text" id="actionTakenHelp">Describe the actions taken to resolve this issue</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="customerComment" class="form-label">Customer Comment</label>
                                    <textarea class="form-control" id="customerComment" rows="3" aria-describedby="customerCommentHelp"></textarea>
                                    <div class="form-text" id="customerCommentHelp">Any comments from the customer</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="supportingFile" class="form-label">Supporting File / Screenshot</label>
                                    <input type="text" class="form-control" id="supportingFile" placeholder="Enter file path or URL" aria-describedby="supportingFileHelp">
                                    <div class="form-text" id="supportingFileHelp">Optional: Link to supporting documentation</div>
                                </div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="reset" class="btn btn-secondary">Clear Form</button>
                                <button type="submit" class="btn btn-primary">Save Case</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- All Cases Tab -->
            <div class="tab-pane fade" id="cases" role="tabpanel" aria-labelledby="cases-tab">
                <div class="filter-section mt-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filterChannel" class="form-label">Filter by Channel</label>
                            <select class="form-select" id="filterChannel" aria-label="Filter by channel">
                                <option value="">All Channels</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterPlatform" class="form-label">Filter by Platform</label>
                            <select class="form-select" id="filterPlatform" aria-label="Filter by platform">
                                <option value="">All Platforms</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterBranch" class="form-label">Filter by Branch</label>
                            <select class="form-select" id="filterBranch" aria-label="Filter by branch">
                                <option value="">All Branches</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterStatus" class="form-label">Filter by Status</label>
                            <select class="form-select" id="filterStatus" aria-label="Filter by status">
                                <option value="">All Statuses</option>
                                <option value="Open">Open</option>
                                <option value="Pending">Pending</option>
                                <option value="Manager Review">Manager Review</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label for="dateFrom" class="form-label">Date From</label>
                            <input type="date" class="form-control" id="dateFrom" aria-label="Date from">
                        </div>
                        <div class="col-md-6">
                            <label for="dateTo" class="form-label">Date To</label>
                            <input type="date" class="form-control" id="dateTo" aria-label="Date to">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="searchInput" class="form-label">Search</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search cases..." aria-label="Search cases">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-primary me-2" id="applyFilters">Apply Filters</button>
                            <button class="btn btn-outline-secondary" id="resetFilters">Reset Filters</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>All Compensation Cases</h5>
                        <span id="casesCount" class="badge bg-primary">0 cases</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="table table-striped table-hover mb-0" aria-label="All cases table">
                                <thead>
                                    <tr>
                                        <th>Case ID</th>
                                        <th>Date</th>
                                        <th>Channel</th>
                                        <th>Platform</th>
                                        <th>Branch</th>
                                        <th>Order #</th>
                                        <th>Customer</th>
                                        <th>Issue Type</th>
                                        <th>Compensation</th>
                                        <th>Status</th>
                                        <th>Agent</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="casesTableBody">
                                    <tr>
                                        <td colspan="12" class="text-center">No cases found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Channels Tab -->
            <div class="tab-pane fade" id="channels" role="tabpanel" aria-labelledby="channels-tab">
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Channel Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-globe" style="font-size: 2rem; color: var(--info-color);"></i>
                                        <h6 class="mt-2">Platform Channels</h6>
                                        <h4 class="text-info" id="platformChannelCount">0</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-telephone-fill" style="font-size: 2rem; color: var(--warning-color);"></i>
                                        <h6 class="mt-2">Call Center Channels</h6>
                                        <h4 class="text-warning" id="callCenterChannelCount">0</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-headset" style="font-size: 2rem; color: var(--success-color);"></i>
                                        <h6 class="mt-2">Online Channels</h6>
                                        <h4 class="text-success" id="onlineChannelCount">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Manage Channels</h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="channelTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="platform-channels-tab" data-bs-toggle="tab" data-bs-target="#platform-channels" type="button" role="tab">Platform Channels</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="call-center-channels-tab" data-bs-toggle="tab" data-bs-target="#call-center-channels" type="button" role="tab">Call Center Channels</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="online-channels-tab" data-bs-toggle="tab" data-bs-target="#online-channels" type="button" role="tab">Online Channels</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="channelTabContent">
                            <div class="tab-pane fade show active" id="platform-channels" role="tabpanel">
                                <div class="mt-3">
                                    <form id="platformChannelForm" class="mb-3">
                                        <div class="dynamic-input-group">
                                            <input type="text" class="form-control" id="newPlatformChannel" placeholder="Enter new platform channel" required>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-plus" aria-hidden="true"></i> Add
                                            </button>
                                        </div>
                                    </form>
                                    <div class="dynamic-list" id="platformChannelsList" role="list" aria-label="Platform channels list">
                                        <!-- Platform channels will be listed here -->
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="call-center-channels" role="tabpanel">
                                <div class="mt-3">
                                    <form id="callCenterChannelForm" class="mb-3">
                                        <div class="dynamic-input-group">
                                            <input type="text" class="form-control" id="newCallCenterChannel" placeholder="Enter new call center channel" required>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-plus" aria-hidden="true"></i> Add
                                            </button>
                                        </div>
                                    </form>
                                    <div class="dynamic-list" id="callCenterChannelsList" role="list" aria-label="Call center channels list">
                                        <!-- Call center channels will be listed here -->
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="online-channels" role="tabpanel">
                                <div class="mt-3">
                                    <form id="onlineChannelForm" class="mb-3">
                                        <div class="dynamic-input-group">
                                            <input type="text" class="form-control" id="newOnlineChannel" placeholder="Enter new online channel" required>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-plus" aria-hidden="true"></i> Add
                                            </button>
                                        </div>
                                    </form>
                                    <div class="dynamic-list" id="onlineChannelsList" role="list" aria-label="Online channels list">
                                        <!-- Online channels will be listed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Channel Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-striped" aria-label="Channel performance table">
                                <thead>
                                    <tr>
                                        <th>Channel</th>
                                        <th>Type</th>
                                        <th>Total Cases</th>
                                        <th>Open Cases</th>
                                        <th>Closed Cases</th>
                                        <th>Resolution Rate</th>
                                        <th>Total Compensation</th>
                                    </tr>
                                </thead>
                                <tbody id="channelPerformanceTable">
                                    <tr>
                                        <td colspan="7" class="text-center">No data available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Import/Export Tab -->
            <div class="tab-pane fade" id="import" role="tabpanel" aria-labelledby="import-tab">
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Import Data from Excel</h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea" role="button" tabindex="0" aria-label="Upload area for Excel files">
                            <i class="bi bi-cloud-upload" style="font-size: 3rem; color: var(--primary-color);" aria-hidden="true"></i>
                            <h5 class="mt-3">Drag & Drop Excel File Here</h5>
                            <p class="text-muted">or</p>
                            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;" aria-label="File input">
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Browse Files</button>
                        </div>
                        
                        <div class="mt-4">
                            <h6>Instructions:</h6>
                            <ol>
                                <li>Download the template below to see the required format</li>
                                <li>Fill in your data following the template structure</li>
                                <li>Upload the completed Excel file</li>
                                <li>Review and confirm the import</li>
                            </ol>
                            
                            <button class="btn btn-outline-primary mt-3" id="downloadTemplate">
                                <i class="bi bi-download" aria-hidden="true"></i> Download Template
                            </button>
                        </div>
                        
                        <div id="importPreview" style="display: none;">
                            <h6 class="mt-4">Import Preview</h6>
                            <div class="table-container">
                                <table class="table table-striped" aria-label="Import preview table">
                                    <thead>
                                        <tr>
                                            <th>Case ID</th>
                                            <th>Date</th>
                                            <th>Channel</th>
                                            <th>Platform</th>
                                            <th>Branch</th>
                                            <th>Order #</th>
                                            <th>Customer</th>
                                            <th>Issue Type</th>
                                            <th>Compensation</th>
                                            <th>Status</th>
                                            <th>Agent</th>
                                        </tr>
                                    </thead>
                                    <tbody id="importPreviewBody">
                                        <!-- Preview data will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-success" id="confirmImport">Confirm Import</button>
                                <button class="btn btn-outline-secondary" id="cancelImport">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Export Data</h5>
                    </div>
                    <div class="card-body">
                        <p>Export all compensation cases to Excel for backup or analysis:</p>
                        <div class="export-buttons">
                            <button class="btn btn-success" id="exportAllData">
                                <i class="bi bi-file-earmark-excel" aria-hidden="true"></i> Export All Data to Excel
                            </button>
                            <button class="btn btn-info" id="exportFilteredData" style="display: none;">
                                <i class="bi bi-filter" aria-hidden="true"></i> Export Filtered Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WhatsApp Tab -->
            <div class="tab-pane fade" id="whatsapp" role="tabpanel" aria-labelledby="whatsapp-tab">
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>WhatsApp Manager Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="manager-settings">
                            <form id="managerSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="managerName" class="form-label">Manager Name</label>
                                        <input type="text" class="form-control" id="managerName" placeholder="Enter manager name" value="Operations Manager" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="managerPhone" class="form-label">Manager WhatsApp Number</label>
                                        <input type="tel" class="form-control" id="managerPhone" placeholder="With country code (e.g., +971501234567)" value="+971501234567" pattern="[\+]?[0-9]{10,15}" required>
                                        <div class="form-text">Include country code (e.g., +971 for UAE)</div>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-12">
                                        <label for="customMessage" class="form-label">Custom Message Template</label>
                                        <textarea class="form-control" id="customMessage" rows="6" placeholder="Custom message template (optional)" aria-describedby="messageTemplateHelp">Dear Manager,

Please review and approve the following compensation case:

üìã Case Details:
‚Ä¢ Case ID: {caseId}
‚Ä¢ Date: {date}
‚Ä¢ Channel: {channel}
‚Ä¢ Platform: {platform}
‚Ä¢ Branch: {branch}
‚Ä¢ Order #: {orderNumber}
‚Ä¢ Customer: {customerName}
‚Ä¢ Issue: {issueType}
‚Ä¢ Order Value: AED {orderValue}
‚Ä¢ Compensation: AED {compensationValue}
‚Ä¢ Responsible: {responsibleParty}

Action Taken: {actionTaken}

Please reply with APPROVED or REJECTED

Thank you</textarea>
                                        <div class="form-text" id="messageTemplateHelp">Use placeholders in curly braces { } to insert case data</div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary mt-3">Save Settings</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Send Case to Manager</h5>
                    </div>
                    <div class="card-body">
                        <form id="whatsappForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="whatsappCaseSelect" class="form-label">Select Case</label>
                                    <select class="form-select" id="whatsappCaseSelect" required>
                                        <option value="">Select a case to send</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="urgencyLevel" class="form-label">Urgency Level</label>
                                    <select class="form-select" id="urgencyLevel">
                                        <option value="Normal">Normal</option>
                                        <option value="High">High</option>
                                        <option value="Urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="whatsapp-preview" id="whatsappPreview" style="display: none;">
                                <div class="whatsapp-message" id="whatsappMessageContent">
                                    <!-- Message preview will be shown here -->
                                </div>
                                <div class="whatsapp-timestamp" id="whatsappTimestamp"></div>
                            </div>
                            
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-primary" id="previewWhatsAppMessage">
                                    <i class="bi bi-eye" aria-hidden="true"></i> Preview Message
                                </button>
                                <button type="button" class="btn btn-whatsapp" id="sendWhatsAppMessage" style="display: none;">
                                    <i class="bi bi-whatsapp" aria-hidden="true"></i> Send via WhatsApp
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5>WhatsApp History</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="table table-striped" aria-label="WhatsApp history table">
                                <thead>
                                    <tr>
                                        <th>Case ID</th>
                                        <th>Sent To</th>
                                        <th>Message</th>
                                        <th>Urgency</th>
                                        <th>Status</th>
                                        <th>Sent Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="whatsappHistoryBody">
                                    <tr>
                                        <td colspan="7" class="text-center">No WhatsApp messages sent yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Manage Issue Types</h5>
                    </div>
                    <div class="card-body">
                        <form id="issueTypeForm" class="mb-3">
                            <div class="dynamic-input-group">
                                <input type="text" class="form-control" id="newIssueType" placeholder="Enter new issue type" required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-plus" aria-hidden="true"></i> Add
                                </button>
                            </div>
                        </form>
                        <div class="dynamic-list" id="issueTypesList" role="list" aria-label="Issue types list">
                            <!-- Issue types will be listed here -->
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Manage Branches</h5>
                    </div>
                    <div class="card-body">
                        <form id="branchForm" class="mb-3">
                            <div class="dynamic-input-group">
                                <input type="text" class="form-control" id="newBranch" placeholder="Enter new branch name" required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-plus" aria-hidden="true"></i> Add
                                </button>
                            </div>
                        </form>
                        <div class="dynamic-list" id="branchesList" role="list" aria-label="Branches list">
                            <!-- Branches will be listed here -->
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Data Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
                            <strong>Warning:</strong> The following actions cannot be undone. Please backup your data before proceeding.
                        </div>
                        <div class="d-grid gap-2 d-md-flex">
                            <button class="btn btn-outline-danger" id="clearAllData">
                                <i class="bi bi-trash" aria-hidden="true"></i> Clear All Data
                            </button>
                            <button class="btn btn-outline-info" id="resetToDefaults">
                                <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> Reset to Defaults
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Generate Reports</h5>
                    </div>
                    <div class="card-body">
                        <form id="reportForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="reportType" class="form-label">Report Type</label>
                                    <select class="form-select" id="reportType" required>
                                        <option value="summary">Summary Report</option>
                                        <option value="detailed">Detailed Report</option>
                                        <option value="channel">Channel Performance</option>
                                        <option value="platform">Platform Performance</option>
                                        <option value="branch">Branch Performance</option>
                                        <option value="agent">Agent Performance</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="reportPeriod" class="form-label">Report Period</label>
                                    <select class="form-select" id="reportPeriod" required>
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="quarter">This Quarter</option>
                                        <option value="year">This Year</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-3 mt-2" id="customDateRange" style="display: none;">
                                <div class="col-md-6">
                                    <label for="reportDateFrom" class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="reportDateFrom" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="reportDateTo" class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="reportDateTo" required>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-file-earmark-text" aria-hidden="true"></i> Generate Report
                                    </button>
                                    <button type="button" class="btn btn-success" id="exportExcel" disabled>
                                        <i class="bi bi-file-earmark-excel" aria-hidden="true"></i> Export to Excel
                                    </button>
                                    <button type="button" class="btn btn-info" id="exportPDF" disabled>
                                        <i class="bi bi-file-earmark-pdf" aria-hidden="true"></i> Export to PDF
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-4" id="reportPreview" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Report Preview</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary no-print" id="printReport">
                                <i class="bi bi-printer" aria-hidden="true"></i> Print
                            </button>
                        </div>
                    </div>
                    <div class="card-body" id="reportContent">
                        <!-- Report content will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Case Details Modal -->
    <div class="modal fade" id="caseDetailsModal" tabindex="-1" aria-labelledby="caseDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="caseDetailsModalLabel">Case Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="caseDetailsContent">
                    <!-- Case details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="editCaseBtn">
                        <i class="bi bi-pencil" aria-hidden="true"></i> Edit Case
                    </button>
                    <button type="button" class="btn btn-whatsapp" id="sendWhatsAppBtn">
                        <i class="bi bi-whatsapp" aria-hidden="true"></i> Send via WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Case Modal -->
    <div class="modal fade" id="editCaseModal" tabindex="-1" aria-labelledby="editCaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCaseModalLabel">Edit Case</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCaseForm" novalidate>
                        <!-- Edit form fields will be populated here -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveChangesBtn">
                        <i class="bi bi-check-lg" aria-hidden="true"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Crispy Chicken Compensation Tracking System</h5>
                    <p>Managing compensation cases across all platforms and channels.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>&copy; 2023 Crispy Chicken. All rights reserved.</p>
                    <p>Version 1.0.0 | Last Updated: <span id="footerLastUpdated">Never</span></p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Application State Management
        const AppState = {
            compensationCases: [],
            currentEditingCaseId: null,
            charts: {
                channel: null,
                platform: null,
                branch: null,
                status: null,
                issueType: null
            },
            importData: [],
            whatsappHistory: [],
            managerSettings: {
                name: 'Operations Manager',
                phone: '+971501234567',
                customMessage: `Dear Manager,

Please review and approve the following compensation case:

üìã Case Details:
‚Ä¢ Case ID: {caseId}
‚Ä¢ Date: {date}
‚Ä¢ Channel: {channel}
‚Ä¢ Platform: {platform}
‚Ä¢ Branch: {branch}
‚Ä¢ Order #: {orderNumber}
‚Ä¢ Customer: {customerName}
‚Ä¢ Issue: {issueType}
‚Ä¢ Order Value: AED {orderValue}
‚Ä¢ Compensation: AED {compensationValue}
‚Ä¢ Responsible: {responsibleParty}

Action Taken: {actionTaken}

Please reply with APPROVED or REJECTED

Thank you`
            },
            channels: {
                platform: ['Noon', 'Careem', 'Smile', 'Deliveroo', 'Keita'],
                callCenter: ['Delivery Call Center', 'Customer Service Hotline'],
                online: ['Online Call Center', 'Website Chat', 'Email Support']
            },
            issueTypes: [
                'Missing Item',
                'Late Delivery',
                'Wrong Order',
                'Refund Request',
                'Double Charge',
                'Food Quality',
                'Other'
            ],
            branches: [
                'Hamdan',
                'Khaldia',
                'Shabiya 11',
                'Muroor',
                'Electra',
                'Barsha',
                'Satwa',
                'New Branch'
            ],
            filteredCases: null
        };

        // Utility Functions
        const Utils = {
            // Safe localStorage operations
            storage: {
                get: function(key, defaultValue = null) {
                    try {
                        const item = localStorage.getItem(key);
                        return item ? JSON.parse(item) : defaultValue;
                    } catch (error) {
                        console.error(`Error reading from localStorage: ${error}`);
                        return defaultValue;
                    }
                },
                set: function(key, value) {
                    try {
                        localStorage.setItem(key, JSON.stringify(value));
                        return true;
                    } catch (error) {
                        console.error(`Error writing to localStorage: ${error}`);
                        showToast('Storage error: Unable to save data', 'danger');
                        return false;
                    }
                },
                remove: function(key) {
                    try {
                        localStorage.removeItem(key);
                        return true;
                    } catch (error) {
                        console.error(`Error removing from localStorage: ${error}`);
                        return false;
                    }
                }
            },

            // Date formatting
            formatDate: function(dateString) {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return 'Invalid Date';
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (error) {
                    console.error('Date formatting error:', error);
                    return 'Invalid Date';
                }
            },

            formatDateTime: function(dateString) {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return 'Invalid Date';
                    return date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    console.error('DateTime formatting error:', error);
                    return 'Invalid Date';
                }
            },

            // Input sanitization
            sanitizeInput: function(input) {
                if (typeof input !== 'string') return input;
                return input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                          .replace(/javascript:/gi, '')
                          .trim();
            },

            // Generate unique ID
            generateId: function(prefix = 'CC') {
                const date = new Date();
                const timestamp = date.getTime();
                const random = Math.floor(Math.random() * 1000);
                return `${prefix}-${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}-${String(random).padStart(3, '0')}`;
            },

            // Validate phone number
            validatePhone: function(phone) {
                const phoneRegex = /^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,9}$/;
                return phoneRegex.test(phone);
            },

            // Get channel type
            getChannelType: function(channel) {
                if (AppState.channels.platform.includes(channel)) return 'platform';
                if (AppState.channels.callCenter.includes(channel)) return 'callCenter';
                if (AppState.channels.online.includes(channel)) return 'online';
                return 'unknown';
            },

            // Debounce function
            debounce: function(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Toast notification system
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = {
                'success': 'bg-success',
                'warning': 'bg-warning',
                'danger': 'bg-danger',
                'info': 'bg-info'
            }[type] || 'bg-info';
            
            const toastHtml = `
                <div id="${toastId}" class="toast custom-toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${Utils.sanitizeInput(message)}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: duration
            });
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        // Loading spinner
        function showLoadingSpinner(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                spinner.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeApp();
                setupEventListeners();
                
                // Add sample data if no data exists
                if (AppState.compensationCases.length === 0) {
                    addSampleData();
                }
                
                // Update current month label
                updateCurrentMonthLabel();
                
                // Initialize tooltips
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                
            } catch (error) {
                console.error('Application initialization error:', error);
                showToast('Application failed to initialize properly', 'danger');
            }
        });

        // Initialize application data
        function initializeApp() {
            // Load data from localStorage
            AppState.compensationCases = Utils.storage.get('compensationCases', []);
            AppState.whatsappHistory = Utils.storage.get('whatsappHistory', []);
            AppState.managerSettings = Utils.storage.get('managerSettings', AppState.managerSettings);
            AppState.channels = Utils.storage.get('channels', AppState.channels);
            AppState.issueTypes = Utils.storage.get('issueTypes', AppState.issueTypes);
            AppState.branches = Utils.storage.get('branches', AppState.branches);
            
            // Set today's date as default
            const dateInput = document.getElementById('date');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
            
            // Generate initial case ID
            generateCaseId();
            
            // Load data and update UI
            loadCases();
            updateDashboard();
            updateLastUpdated();
            loadManagerSettings();
            loadWhatsAppHistory();
            updateWhatsAppCaseSelect();
            updateDynamicSelects();
            loadSettingsData();
            loadChannelData();
            updateChannelOverview();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Form submissions
            const newCaseForm = document.getElementById('newCaseForm');
            if (newCaseForm) {
                newCaseForm.addEventListener('submit', handleNewCaseSubmit);
            }
            
            const editCaseForm = document.getElementById('editCaseForm');
            if (editCaseForm) {
                editCaseForm.addEventListener('submit', handleEditCaseSubmit);
            }
            
            const managerSettingsForm = document.getElementById('managerSettingsForm');
            if (managerSettingsForm) {
                managerSettingsForm.addEventListener('submit', handleManagerSettingsSubmit);
            }
            
            const whatsappForm = document.getElementById('whatsappForm');
            if (whatsappForm) {
                whatsappForm.addEventListener('submit', handleWhatsAppSubmit);
            }
            
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                reportForm.addEventListener('submit', handleReportSubmit);
            }
            
            const issueTypeForm = document.getElementById('issueTypeForm');
            if (issueTypeForm) {
                issueTypeForm.addEventListener('submit', handleIssueTypeSubmit);
            }
            
            const branchForm = document.getElementById('branchForm');
            if (branchForm) {
                branchForm.addEventListener('submit', handleBranchSubmit);
            }
            
            // Channel forms
            const platformChannelForm = document.getElementById('platformChannelForm');
            if (platformChannelForm) {
                platformChannelForm.addEventListener('submit', handlePlatformChannelSubmit);
            }
            
            const callCenterChannelForm = document.getElementById('callCenterChannelForm');
            if (callCenterChannelForm) {
                callCenterChannelForm.addEventListener('submit', handleCallCenterChannelSubmit);
            }
            
            const onlineChannelForm = document.getElementById('onlineChannelForm');
            if (onlineChannelForm) {
                onlineChannelForm.addEventListener('submit', handleOnlineChannelSubmit);
            }
            
            // Filter controls
            const applyFiltersBtn = document.getElementById('applyFilters');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', applyFilters);
            }
            
            const resetFiltersBtn = document.getElementById('resetFilters');
            if (resetFiltersBtn) {
                resetFiltersBtn.addEventListener('click', resetFilters);
            }
            
            // Search with debounce
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', Utils.debounce(applyFilters, 300));
            }
            
            // Report period change
            const reportPeriod = document.getElementById('reportPeriod');
            if (reportPeriod) {
                reportPeriod.addEventListener('change', handleReportPeriodChange);
            }
            
            // File operations
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            // Drag and drop
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                setupDragAndDrop(uploadArea);
            }
            
            // WhatsApp controls
            const previewWhatsAppBtn = document.getElementById('previewWhatsAppMessage');
            if (previewWhatsAppBtn) {
                previewWhatsAppBtn.addEventListener('click', previewWhatsAppMessage);
            }
            
            const sendWhatsAppBtn = document.getElementById('sendWhatsAppMessage');
            if (sendWhatsAppBtn) {
                sendWhatsAppBtn.addEventListener('click', sendWhatsAppMessage);
            }
            
            // Export/Import controls
            const downloadTemplateBtn = document.getElementById('downloadTemplate');
            if (downloadTemplateBtn) {
                downloadTemplateBtn.addEventListener('click', downloadTemplate);
            }
            
            const confirmImportBtn = document.getElementById('confirmImport');
            if (confirmImportBtn) {
                confirmImportBtn.addEventListener('click', confirmImport);
            }
            
            const cancelImportBtn = document.getElementById('cancelImport');
            if (cancelImportBtn) {
                cancelImportBtn.addEventListener('click', cancelImport);
            }
            
            const exportAllDataBtn = document.getElementById('exportAllData');
            if (exportAllDataBtn) {
                exportAllDataBtn.addEventListener('click', () => exportData(false));
            }
            
            const exportFilteredDataBtn = document.getElementById('exportFilteredData');
            if (exportFilteredDataBtn) {
                exportFilteredDataBtn.addEventListener('click', () => exportData(true));
            }
            
            // Report export buttons
            const exportExcelBtn = document.getElementById('exportExcel');
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', () => exportReport('excel'));
            }
            
            const exportPDFBtn = document.getElementById('exportPDF');
            if (exportPDFBtn) {
                exportPDFBtn.addEventListener('click', () => exportReport('pdf'));
            }
            
            const printReportBtn = document.getElementById('printReport');
            if (printReportBtn) {
                printReportBtn.addEventListener('click', printReport);
            }
            
            // Modal buttons
            const editCaseBtn = document.getElementById('editCaseBtn');
            if (editCaseBtn) {
                editCaseBtn.addEventListener('click', () => editCase(AppState.currentEditingCaseId));
            }
            
            const sendWhatsAppModalBtn = document.getElementById('sendWhatsAppBtn');
            if (sendWhatsAppModalBtn) {
                sendWhatsAppModalBtn.addEventListener('click', () => sendCaseWhatsApp(AppState.currentEditingCaseId));
            }
            
            const saveChangesBtn = document.getElementById('saveChangesBtn');
            if (saveChangesBtn) {
                saveChangesBtn.addEventListener('click', saveCaseChanges);
            }
            
            // Settings buttons
            const clearAllDataBtn = document.getElementById('clearAllData');
            if (clearAllDataBtn) {
                clearAllDataBtn.addEventListener('click', clearAllData);
            }
            
            const resetToDefaultsBtn = document.getElementById('resetToDefaults');
            if (resetToDefaultsBtn) {
                resetToDefaultsBtn.addEventListener('click', resetToDefaults);
            }
            
            // Tab change events
            const dashboardTab = document.getElementById('dashboard-tab');
            if (dashboardTab) {
                dashboardTab.addEventListener('shown.bs.tab', updateDashboard);
            }
            
            // Form reset
            const newCaseFormReset = document.querySelector('#newCaseForm button[type="reset"]');
            if (newCaseFormReset) {
                newCaseFormReset.addEventListener('click', () => {
                    setTimeout(generateCaseId, 10);
                    clearValidationErrors('newCaseForm');
                });
            }
        }

        // Form submission handlers
        function handleNewCaseSubmit(e) {
            e.preventDefault();
            
            if (!validateForm('newCaseForm')) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            saveNewCase();
        }

        function handleEditCaseSubmit(e) {
            e.preventDefault();
            
            if (!validateForm('editCaseForm')) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            saveCaseChanges();
        }

        function handleManagerSettingsSubmit(e) {
            e.preventDefault();
            saveManagerSettings();
        }

        function handleWhatsAppSubmit(e) {
            e.preventDefault();
            sendWhatsAppMessage();
        }

        function handleReportSubmit(e) {
            e.preventDefault();
            generateReport();
        }

        function handleIssueTypeSubmit(e) {
            e.preventDefault();
            addIssueType();
        }

        function handleBranchSubmit(e) {
            e.preventDefault();
            addBranch();
        }

        function handlePlatformChannelSubmit(e) {
            e.preventDefault();
            addChannel('platform');
        }

        function handleCallCenterChannelSubmit(e) {
            e.preventDefault();
            addChannel('callCenter');
        }

        function handleOnlineChannelSubmit(e) {
            e.preventDefault();
            addChannel('online');
        }

        // Form validation
        function validateForm(formId) {
            const form = document.getElementById(formId);
            if (!form) return false;
            
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
                
                // Special validation for phone numbers
                if (field.type === 'tel' && field.value) {
                    if (!Utils.validatePhone(field.value)) {
                        field.classList.add('is-invalid');
                        isValid = false;
                    }
                }
                
                // Special validation for numbers
                if (field.type === 'number' && field.value) {
                    if (isNaN(field.value) || parseFloat(field.value) < 0) {
                        field.classList.add('is-invalid');
                        isValid = false;
                    }
                }
            });
            
            return isValid;
        }

        function clearValidationErrors(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            
            const invalidFields = form.querySelectorAll('.is-invalid');
            invalidFields.forEach(field => {
                field.classList.remove('is-invalid');
            });
        }

        // Generate unique case ID
        function generateCaseId() {
            const caseId = Utils.generateId();
            const caseIdInput = document.getElementById('caseId');
            if (caseIdInput) {
                caseIdInput.value = caseId;
            }
        }

        // Update current month label
        function updateCurrentMonthLabel() {
            const now = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            const label = document.getElementById('currentMonthLabel');
            if (label) {
                label.textContent = monthNames[now.getMonth()] + " " + now.getFullYear();
            }
        }

        // Add sample data
        function addSampleData() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const sampleCases = [
                {
                    id: Utils.generateId(),
                    date: new Date(currentYear, currentMonth, 5).toISOString().split('T')[0],
                    channel: 'Noon',
                    platform: 'Noon',
                    branch: 'Hamdan',
                    orderNumber: 'ORD123456',
                    customerName: 'John Doe',
                    issueType: 'Missing Item',
                    orderValue: 85.50,
                    compensationValue: 20.00,
                    responsibleParty: 'Restaurant',
                    status: 'Closed',
                    actionTaken: 'Refund processed via platform',
                    agentName: 'Agent A',
                    dateClosed: new Date(currentYear, currentMonth, 6).toISOString(),
                    supportingFile: '',
                    customerComment: 'Customer was satisfied with the resolution',
                    createdAt: new Date(currentYear, currentMonth, 5).toISOString()
                },
                {
                    id: Utils.generateId(),
                    date: new Date(currentYear, currentMonth, 10).toISOString().split('T')[0],
                    channel: 'Delivery Call Center',
                    platform: 'Careem',
                    branch: 'Khaldia',
                    orderNumber: 'ORD789012',
                    customerName: 'Jane Smith',
                    issueType: 'Late Delivery',
                    orderValue: 120.00,
                    compensationValue: 30.00,
                    responsibleParty: 'Driver',
                    status: 'Open',
                    actionTaken: 'Contacted driver for explanation',
                    agentName: 'Agent B',
                    dateClosed: null,
                    supportingFile: '',
                    customerComment: 'Customer is very upset about the delay',
                    createdAt: new Date(currentYear, currentMonth, 10).toISOString()
                },
                {
                    id: Utils.generateId(),
                    date: new Date(currentYear, currentMonth, 15).toISOString().split('T')[0],
                    channel: 'Online Call Center',
                    platform: 'Deliveroo',
                    branch: 'Muroor',
                    orderNumber: 'ORD345678',
                    customerName: 'Mike Johnson',
                    issueType: 'Wrong Order',
                    orderValue: 95.00,
                    compensationValue: 25.00,
                    responsibleParty: 'Restaurant',
                    status: 'Pending',
                    actionTaken: 'Resending correct order',
                    agentName: 'Agent A',
                    dateClosed: null,
                    supportingFile: '',
                    customerComment: 'Customer received wrong items and wants replacement',
                    createdAt: new Date(currentYear, currentMonth, 15).toISOString()
                },
                {
                    id: Utils.generateId(),
                    date: new Date(currentYear, currentMonth - 1, 20).toISOString().split('T')[0],
                    channel: 'Smile',
                    platform: 'Smile',
                    branch: 'Electra',
                    orderNumber: 'ORD901234',
                    customerName: 'Sarah Williams',
                    issueType: 'Double Charge',
                    orderValue: 65.00,
                    compensationValue: 65.00,
                    responsibleParty: 'Platform',
                    status: 'Closed',
                    actionTaken: 'Refund processed',
                    agentName: 'Agent C',
                    dateClosed: new Date(currentYear, currentMonth - 1, 21).toISOString(),
                    supportingFile: '',
                    customerComment: 'Customer appreciated quick refund',
                    createdAt: new Date(currentYear, currentMonth - 1, 20).toISOString()
                },
                {
                    id: Utils.generateId(),
                    date: new Date(currentYear, currentMonth - 1, 25).toISOString().split('T')[0],
                    channel: 'Customer Service Hotline',
                    platform: 'Keita',
                    branch: 'Barsha',
                    orderNumber: 'ORD567890',
                    customerName: 'Robert Brown',
                    issueType: 'Food Quality',
                    orderValue: 110.00,
                    compensationValue: 40.00,
                    responsibleParty: 'Restaurant',
                    status: 'Closed',
                    actionTaken: 'Replacement order sent',
                    agentName: 'Agent B',
                    dateClosed: new Date(currentYear, currentMonth - 1, 26).toISOString(),
                    supportingFile: '',
                    customerComment: 'Customer accepted the replacement',
                    createdAt: new Date(currentYear, currentMonth - 1, 25).toISOString()
                }
            ];
            
            AppState.compensationCases = sampleCases;
            Utils.storage.set('compensationCases', AppState.compensationCases);
            loadCases();
            updateDashboard();
        }

        // Save new case
        function saveNewCase() {
            showLoadingSpinner(true);
            
            try {
                const newCase = {
                    id: document.getElementById('caseId').value,
                    date: document.getElementById('date').value,
                    channel: document.getElementById('channel').value,
                    platform: document.getElementById('platform').value,
                    branch: document.getElementById('branch').value,
                    orderNumber: Utils.sanitizeInput(document.getElementById('orderNumber').value),
                    customerName: Utils.sanitizeInput(document.getElementById('customerName').value),
                    issueType: document.getElementById('issueType').value,
                    orderValue: parseFloat(document.getElementById('orderValue').value),
                    compensationValue: parseFloat(document.getElementById('compensationValue').value),
                    responsibleParty: document.getElementById('responsibleParty').value,
                    status: document.getElementById('status').value,
                    actionTaken: Utils.sanitizeInput(document.getElementById('actionTaken').value),
                    agentName: Utils.sanitizeInput(document.getElementById('agentName').value),
                    callReference: Utils.sanitizeInput(document.getElementById('callReference').value),
                    dateClosed: document.getElementById('status').value === 'Closed' ? new Date().toISOString() : null,
                    supportingFile: Utils.sanitizeInput(document.getElementById('supportingFile').value),
                    customerComment: Utils.sanitizeInput(document.getElementById('customerComment').value),
                    createdAt: new Date().toISOString()
                };
                
                // Check for duplicate order number
                const duplicate = AppState.compensationCases.find(c => 
                    c.orderNumber === newCase.orderNumber && c.platform === newCase.platform
                );
                
                if (duplicate) {
                    showToast('Warning: A case with this order number already exists', 'warning');
                }
                
                // Add to array
                AppState.compensationCases.push(newCase);
                
                // Save to localStorage
                if (!Utils.storage.set('compensationCases', AppState.compensationCases)) {
                    showLoadingSpinner(false);
                    return;
                }
                
                // Reset form and generate new case ID
                document.getElementById('newCaseForm').reset();
                document.getElementById('date').valueAsDate = new Date();
                generateCaseId();
                clearValidationErrors('newCaseForm');
                
                // Update UI
                setTimeout(() => {
                    loadCases();
                    updateDashboard();
                    updateLastUpdated();
                    updateWhatsAppCaseSelect();
                    updateChannelOverview();
                    
                    showLoadingSpinner(false);
                    showToast('Case saved successfully!', 'success');
                    
                    // Switch to dashboard tab
                    const dashboardTab = new bootstrap.Tab(document.getElementById('dashboard-tab'));
                    dashboardTab.show();
                }, 500);
                
            } catch (error) {
                console.error('Error saving case:', error);
                showLoadingSpinner(false);
                showToast('Error saving case. Please try again.', 'danger');
            }
        }

        // Load cases into table
        function loadCases(cases = null) {
            const casesToDisplay = cases || AppState.filteredCases || AppState.compensationCases;
            const tableBody = document.getElementById('casesTableBody');
            
            if (!tableBody) return;
            
            if (casesToDisplay.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="12" class="text-center">No cases found</td></tr>';
                const casesCount = document.getElementById('casesCount');
                if (casesCount) {
                    casesCount.textContent = '0 cases';
                }
                return;
            }
            
            tableBody.innerHTML = '';
            
            // Sort cases by date (newest first)
            const sortedCases = [...casesToDisplay].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedCases.forEach(caseItem => {
                const channelType = Utils.getChannelType(caseItem.channel);
                const channelBadgeClass = channelType === 'platform' ? 'channel-platform' : 
                                         channelType === 'callCenter' ? 'channel-call' : 'channel-online';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${caseItem.id}</td>
                    <td>${Utils.formatDate(caseItem.date)}</td>
                    <td>
                        <span class="channel-badge ${channelBadgeClass}">${caseItem.channel}</span>
                    </td>
                    <td>${caseItem.platform}</td>
                    <td>${caseItem.branch}</td>
                    <td>${caseItem.orderNumber}</td>
                    <td>${caseItem.customerName}</td>
                    <td>${caseItem.issueType}</td>
                    <td>AED ${caseItem.compensationValue.toFixed(2)}</td>
                    <td><span class="status-badge status-${caseItem.status.toLowerCase().replace(' ', '-')}">${caseItem.status}</span></td>
                    <td>${caseItem.agentName}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-info" onclick="viewCaseDetails('${caseItem.id}')" aria-label="View case ${caseItem.id}">
                                <i class="bi bi-eye" aria-hidden="true"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editCase('${caseItem.id}')" aria-label="Edit case ${caseItem.id}">
                                <i class="bi bi-pencil" aria-hidden="true"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="sendCaseWhatsApp('${caseItem.id}')" aria-label="Send case ${caseItem.id} via WhatsApp">
                                <i class="bi bi-whatsapp" aria-hidden="true"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCase('${caseItem.id}')" aria-label="Delete case ${caseItem.id}">
                                <i class="bi bi-trash" aria-hidden="true"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            const casesCount = document.getElementById('casesCount');
            if (casesCount) {
                casesCount.textContent = `${casesToDisplay.length} case${casesToDisplay.length !== 1 ? 's' : ''}`;
            }
            
            // Show/hide export filtered button
            const exportFilteredBtn = document.getElementById('exportFilteredData');
            if (exportFilteredBtn) {
                exportFilteredBtn.style.display = AppState.filteredCases ? 'inline-block' : 'none';
            }
        }

        // Update dashboard
        function updateDashboard() {
            try {
                // Calculate statistics
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                const monthCases = AppState.compensationCases.filter(caseItem => {
                    const caseDate = new Date(caseItem.date);
                    return caseDate.getMonth() === currentMonth && caseDate.getFullYear() === currentYear;
                });
                
                const openCases = AppState.compensationCases.filter(caseItem => caseItem.status === 'Open');
                const closedCases = AppState.compensationCases.filter(caseItem => caseItem.status === 'Closed');
                
                const totalCompensation = AppState.compensationCases.reduce((sum, caseItem) => sum + caseItem.compensationValue, 0);
                
                const resolutionRate = AppState.compensationCases.length > 0 
                    ? ((closedCases.length / AppState.compensationCases.length) * 100).toFixed(1) 
                    : 0;
                
                // Update stat cards with animation
                animateValue('totalCasesMonth', parseInt(document.getElementById('totalCasesMonth').textContent) || 0, monthCases.length, 500);
                animateValue('openCases', parseInt(document.getElementById('openCases').textContent) || 0, openCases.length, 500);
                
                const totalCompEl = document.getElementById('totalCompensation');
                if (totalCompEl) {
                    totalCompEl.textContent = `AED ${totalCompensation.toFixed(2)}`;
                }
                
                const resolutionRateEl = document.getElementById('resolutionRate');
                if (resolutionRateEl) {
                    resolutionRateEl.textContent = `${resolutionRate}%`;
                }
                
                // Update data count in navbar
                const dataCountEl = document.getElementById('dataCount');
                if (dataCountEl) {
                    dataCountEl.textContent = `Total Cases: ${AppState.compensationCases.length}`;
                }
                
                // Update charts
                updateCharts();
                updateAgentPerformanceTable();
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        // Animate number changes
        function animateValue(id, start, end, duration) {
            const element = document.getElementById(id);
            if (!element) return;
            
            const range = end - start;
            const increment = range / (duration / 10);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    element.textContent = end;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, 10);
        }

        // Update all charts
        function updateCharts() {
            updateChannelChart();
            updatePlatformChart();
            updateBranchChart();
            updateStatusChart();
            updateIssueTypeChart();
        }

        // Update channel chart
        function updateChannelChart() {
            const ctx = document.getElementById('channelChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (AppState.charts.channel) {
                AppState.charts.channel.destroy();
            }
            
            const channelCounts = {};
            AppState.compensationCases.forEach(caseItem => {
                channelCounts[caseItem.channel] = (channelCounts[caseItem.channel] || 0) + 1;
            });
            
            AppState.charts.channel = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(channelCounts),
                    datasets: [{
                        label: 'Cases by Channel',
                        data: Object.values(channelCounts),
                        backgroundColor: [
                            'rgba(230, 57, 70, 0.7)',
                            'rgba(168, 218, 220, 0.7)',
                            'rgba(241, 250, 238, 0.7)',
                            'rgba(29, 53, 87, 0.7)',
                            'rgba(255, 183, 77, 0.7)',
                            'rgba(73, 80, 87, 0.7)',
                            'rgba(119, 140, 163, 0.7)',
                            'rgba(223, 230, 233, 0.7)'
                        ],
                        borderColor: [
                            'rgba(230, 57, 70, 1)',
                            'rgba(168, 218, 220, 1)',
                            'rgba(241, 250, 238, 1)',
                            'rgba(29, 53, 87, 1)',
                            'rgba(255, 183, 77, 1)',
                            'rgba(73, 80, 87, 1)',
                            'rgba(119, 140, 163, 1)',
                            'rgba(223, 230, 233, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Update platform chart
        function updatePlatformChart() {
            const ctx = document.getElementById('platformChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (AppState.charts.platform) {
                AppState.charts.platform.destroy();
            }
            
            const platformCounts = {};
            AppState.compensationCases.forEach(caseItem => {
                platformCounts[caseItem.platform] = (platformCounts[caseItem.platform] || 0) + 1;
            });
            
            AppState.charts.platform = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(platformCounts),
                    datasets: [{
                        label: 'Cases by Platform',
                        data: Object.values(platformCounts),
                        backgroundColor: [
                            'rgba(230, 57, 70, 0.7)',
                            'rgba(168, 218, 220, 0.7)',
                            'rgba(241, 250, 238, 0.7)',
                            'rgba(29, 53, 87, 0.7)',
                            'rgba(255, 183, 77, 0.7)'
                        ],
                        borderColor: [
                            'rgba(230, 57, 70, 1)',
                            'rgba(168, 218, 220, 1)',
                            'rgba(241, 250, 238, 1)',
                            'rgba(29, 53, 87, 1)',
                            'rgba(255, 183, 77, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update branch chart
        function updateBranchChart() {
            const ctx = document.getElementById('branchChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (AppState.charts.branch) {
                AppState.charts.branch.destroy();
            }
            
            const branchCounts = {};
            AppState.compensationCases.forEach(caseItem => {
                branchCounts[caseItem.branch] = (branchCounts[caseItem.branch] || 0) + 1;
            });
            
            AppState.charts.branch = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(branchCounts),
                    datasets: [{
                        label: 'Cases by Branch',
                        data: Object.values(branchCounts),
                        backgroundColor: [
                            'rgba(230, 57, 70, 0.7)',
                            'rgba(168, 218, 220, 0.7)',
                            'rgba(241, 250, 238, 0.7)',
                            'rgba(29, 53, 87, 0.7)',
                            'rgba(255, 183, 77, 0.7)',
                            'rgba(73, 80, 87, 0.7)',
                            'rgba(119, 140, 163, 0.7)',
                            'rgba(223, 230, 233, 0.7)'
                        ],
                        borderColor: [
                            'rgba(230, 57, 70, 1)',
                            'rgba(168, 218, 220, 1)',
                            'rgba(241, 250, 238, 1)',
                            'rgba(29, 53, 87, 1)',
                            'rgba(255, 183, 77, 1)',
                            'rgba(73, 80, 87, 1)',
                            'rgba(119, 140, 163, 1)',
                            'rgba(223, 230, 233, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Update status chart
        function updateStatusChart() {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (AppState.charts.status) {
                AppState.charts.status.destroy();
            }
            
            const statusCounts = {};
            AppState.compensationCases.forEach(caseItem => {
                statusCounts[caseItem.status] = (statusCounts[caseItem.status] || 0) + 1;
            });
            
            AppState.charts.status = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'Status Breakdown',
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(23, 162, 184, 0.7)',
                            'rgba(111, 66, 193, 0.7)',
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(108, 117, 125, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 193, 7, 1)',
                            'rgba(23, 162, 184, 1)',
                            'rgba(111, 66, 193, 1)',
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)',
                            'rgba(108, 117, 125, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Update issue type chart
        function updateIssueTypeChart() {
            const ctx = document.getElementById('issueTypeChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (AppState.charts.issueType) {
                AppState.charts.issueType.destroy();
            }
            
            const issueTypeCounts = {};
            AppState.compensationCases.forEach(caseItem => {
                issueTypeCounts[caseItem.issueType] = (issueTypeCounts[caseItem.issueType] || 0) + 1;
            });
            
            // Sort and get top 5
            const sortedIssueTypes = Object.entries(issueTypeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            AppState.charts.issueType = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedIssueTypes.map(item => item[0]),
                    datasets: [{
                        label: 'Top Issue Types',
                        data: sortedIssueTypes.map(item => item[1]),
                        backgroundColor: 'rgba(230, 57, 70, 0.7)',
                        borderColor: 'rgba(230, 57, 70, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update agent performance table
        function updateAgentPerformanceTable() {
            const agentPerformance = {};
            
            AppState.compensationCases.forEach(caseItem => {
                if (!agentPerformance[caseItem.agentName]) {
                    agentPerformance[caseItem.agentName] = {
                        casesHandled: 0,
                        closedCases: 0,
                        totalResolutionTime: 0
                    };
                }
                
                agentPerformance[caseItem.agentName].casesHandled++;
                
                if (caseItem.status === 'Closed' && caseItem.dateClosed) {
                    agentPerformance[caseItem.agentName].closedCases++;
                    
                    const createdDate = new Date(caseItem.createdAt);
                    const closedDate = new Date(caseItem.dateClosed);
                    const resolutionTime = Math.floor((closedDate - createdDate) / (1000 * 60 * 60 * 24)); // in days
                    
                    agentPerformance[caseItem.agentName].totalResolutionTime += resolutionTime;
                }
            });
            
            const tableBody = document.getElementById('agentPerformanceTable');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (Object.keys(agentPerformance).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No data available</td></tr>';
                return;
            }
            
            Object.entries(agentPerformance).forEach(([agentName, performance]) => {
                const resolutionRate = performance.casesHandled > 0 
                    ? ((performance.closedCases / performance.casesHandled) * 100).toFixed(1) 
                    : 0;
                
                const avgResolutionTime = performance.closedCases > 0 
                    ? (performance.totalResolutionTime / performance.closedCases).toFixed(1) 
                    : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${agentName}</td>
                    <td>${performance.casesHandled}</td>
                    <td>${resolutionRate}%</td>
                    <td>${avgResolutionTime} days</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Channel management functions
        function loadChannelData() {
            // Update channel selects
            updateChannelSelects();
            
            // Load channel lists
            loadChannelLists();
            
            // Update channel performance table
            updateChannelPerformanceTable();
        }

        function updateChannelSelects() {
            // Update channel select in new case form
            const channelSelect = document.getElementById('channel');
            if (channelSelect) {
                const currentValue = channelSelect.value;
                channelSelect.innerHTML = '<option value="">Select Channel</option>';
                
                // Add platform channels
                const platformGroup = document.createElement('optgroup');
                platformGroup.label = 'Platform Channels';
                AppState.channels.platform.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel;
                    option.textContent = channel;
                    if (channel === currentValue) option.selected = true;
                    platformGroup.appendChild(option);
                });
                channelSelect.appendChild(platformGroup);
                
                // Add call center channels
                const callCenterGroup = document.createElement('optgroup');
                callCenterGroup.label = 'Call Center Channels';
                AppState.channels.callCenter.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel;
                    option.textContent = channel;
                    if (channel === currentValue) option.selected = true;
                    callCenterGroup.appendChild(option);
                });
                channelSelect.appendChild(callCenterGroup);
                
                // Add online channels
                const onlineGroup = document.createElement('optgroup');
                onlineGroup.label = 'Online Channels';
                AppState.channels.online.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel;
                    option.textContent = channel;
                    if (channel === currentValue) option.selected = true;
                    onlineGroup.appendChild(option);
                });
                channelSelect.appendChild(onlineGroup);
            }
            
            // Update filter channel select
            const filterChannelSelect = document.getElementById('filterChannel');
            if (filterChannelSelect) {
                const currentValue = filterChannelSelect.value;
                filterChannelSelect.innerHTML = '<option value="">All Channels</option>';
                
                [...AppState.channels.platform, ...AppState.channels.callCenter, ...AppState.channels.online].forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel;
                    option.textContent = channel;
                    if (channel === currentValue) option.selected = true;
                    filterChannelSelect.appendChild(option);
                });
            }
        }

        function loadChannelLists() {
            // Load platform channels
            const platformChannelsList = document.getElementById('platformChannelsList');
            if (platformChannelsList) {
                platformChannelsList.innerHTML = '';
                AppState.channels.platform.forEach(channel => {
                    const item = document.createElement('div');
                    item.className = 'dynamic-list-item';
                    item.innerHTML = `
                        <span>${channel}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeChannel('platform', '${channel}')" aria-label="Remove ${channel}">
                            <i class="bi bi-trash" aria-hidden="true"></i>
                        </button>
                    `;
                    platformChannelsList.appendChild(item);
                });
            }
            
            // Load call center channels
            const callCenterChannelsList = document.getElementById('callCenterChannelsList');
            if (callCenterChannelsList) {
                callCenterChannelsList.innerHTML = '';
                AppState.channels.callCenter.forEach(channel => {
                    const item = document.createElement('div');
                    item.className = 'dynamic-list-item';
                    item.innerHTML = `
                        <span>${channel}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeChannel('callCenter', '${channel}')" aria-label="Remove ${channel}">
                            <i class="bi bi-trash" aria-hidden="true"></i>
                        </button>
                    `;
                    callCenterChannelsList.appendChild(item);
                });
            }
            
            // Load online channels
            const onlineChannelsList = document.getElementById('onlineChannelsList');
            if (onlineChannelsList) {
                onlineChannelsList.innerHTML = '';
                AppState.channels.online.forEach(channel => {
                    const item = document.createElement('div');
                    item.className = 'dynamic-list-item';
                    item.innerHTML = `
                        <span>${channel}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeChannel('online', '${channel}')" aria-label="Remove ${channel}">
                            <i class="bi bi-trash" aria-hidden="true"></i>
                        </button>
                    `;
                    onlineChannelsList.appendChild(item);
                });
            }
        }

        function updateChannelOverview() {
            const platformCount = document.getElementById('platformChannelCount');
            const callCenterCount = document.getElementById('callCenterChannelCount');
            const onlineCount = document.getElementById('onlineChannelCount');
            
            if (platformCount) platformCount.textContent = AppState.channels.platform.length;
            if (callCenterCount) callCenterCount.textContent = AppState.channels.callCenter.length;
            if (onlineCount) onlineCount.textContent = AppState.channels.online.length;
        }

        function updateChannelPerformanceTable() {
            const channelPerformance = {};
            
            // Initialize all channels
            [...AppState.channels.platform, ...AppState.channels.callCenter, ...AppState.channels.online].forEach(channel => {
                channelPerformance[channel] = {
                    cases: 0,
                    openCases: 0,
                    closedCases: 0,
                    compensation: 0
                };
            });
            
            // Calculate performance metrics
            AppState.compensationCases.forEach(caseItem => {
                if (channelPerformance[caseItem.channel]) {
                    channelPerformance[caseItem.channel].cases++;
                    channelPerformance[caseItem.channel].compensation += caseItem.compensationValue;
                    
                    if (caseItem.status === 'Open') {
                        channelPerformance[caseItem.channel].openCases++;
                    } else if (caseItem.status === 'Closed') {
                        channelPerformance[caseItem.channel].closedCases++;
                    }
                }
            });
            
            const tableBody = document.getElementById('channelPerformanceTable');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            const channelsWithData = Object.entries(channelPerformance).filter(([_, data]) => data.cases > 0);
            
            if (channelsWithData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No data available</td></tr>';
                return;
            }
            
            channelsWithData.forEach(([channel, data]) => {
                const channelType = Utils.getChannelType(channel);
                const resolutionRate = data.cases > 0 
                    ? ((data.closedCases / data.cases) * 100).toFixed(1) 
                    : 0;
                
                const channelBadgeClass = channelType === 'platform' ? 'channel-platform' : 
                                         channelType === 'callCenter' ? 'channel-call' : 'channel-online';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="channel-badge ${channelBadgeClass}">${channel}</span>
                    </td>
                    <td>${channelType.charAt(0).toUpperCase() + channelType.slice(1)}</td>
                    <td>${data.cases}</td>
                    <td>${data.openCases}</td>
                    <td>${data.closedCases}</td>
                    <td>${resolutionRate}%</td>
                    <td>AED ${data.compensation.toFixed(2)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function addChannel(type) {
            const inputId = type === 'platform' ? 'newPlatformChannel' : 
                           type === 'callCenter' ? 'newCallCenterChannel' : 'newOnlineChannel';
            const input = document.getElementById(inputId);
            const value = Utils.sanitizeInput(input.value.trim());
            
            if (!value) {
                showToast(`Please enter a ${type} channel name`, 'warning');
                return;
            }
            
            if (AppState.channels[type].includes(value)) {
                showToast('Channel already exists', 'warning');
                return;
            }
            
            AppState.channels[type].push(value);
            Utils.storage.set('channels', AppState.channels);
            
            input.value = '';
            updateChannelSelects();
            loadChannelLists();
            updateChannelOverview();
            updateChannelPerformanceTable();
            
            showToast('Channel added successfully!', 'success');
        }

        function removeChannel(type, channel) {
            if (!confirm(`Are you sure you want to remove "${channel}"?`)) return;
            
            // Check if any cases use this channel
            const casesWithChannel = AppState.compensationCases.filter(c => c.channel === channel);
            if (casesWithChannel.length > 0) {
                showToast(`Cannot remove: ${casesWithChannel.length} case(s) use this channel`, 'danger');
                return;
            }
            
            AppState.channels[type] = AppState.channels[type].filter(c => c !== channel);
            Utils.storage.set('channels', AppState.channels);
            
            updateChannelSelects();
            loadChannelLists();
            updateChannelOverview();
            updateChannelPerformanceTable();
            
            showToast('Channel removed successfully!', 'success');
        }

        // View case details
        function viewCaseDetails(caseId) {
            const caseItem = AppState.compensationCases.find(c => c.id === caseId);
            if (!caseItem) {
                showToast('Case not found', 'warning');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('caseDetailsModal'));
            const content = document.getElementById('caseDetailsContent');
            
            const channelType = Utils.getChannelType(caseItem.channel);
            const channelBadgeClass = channelType === 'platform' ? 'channel-platform' : 
                                     channelType === 'callCenter' ? 'channel-call' : 'channel-online';
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Case ID:</strong> ${caseItem.id}</p>
                        <p><strong>Date:</strong> ${Utils.formatDate(caseItem.date)}</p>
                        <p><strong>Channel:</strong> <span class="channel-badge ${channelBadgeClass}">${caseItem.channel}</span></p>
                        <p><strong>Platform:</strong> ${caseItem.platform}</p>
                        <p><strong>Branch:</strong> ${caseItem.branch}</p>
                        <p><strong>Order Number:</strong> ${caseItem.orderNumber}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Customer Name:</strong> ${caseItem.customerName}</p>
                        <p><strong>Issue Type:</strong> ${caseItem.issueType}</p>
                        <p><strong>Order Value:</strong> AED ${caseItem.orderValue.toFixed(2)}</p>
                        <p><strong>Compensation Value:</strong> AED ${caseItem.compensationValue.toFixed(2)}</p>
                        <p><strong>Responsible Party:</strong> ${caseItem.responsibleParty}</p>
                        <p><strong>Status:</strong> <span class="status-badge status-${caseItem.status.toLowerCase().replace(' ', '-')}">${caseItem.status}</span></p>
                        <p><strong>Agent Name:</strong> ${caseItem.agentName}</p>
                    </div>
                </div>
                ${caseItem.callReference ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Call Reference:</strong> ${caseItem.callReference}</p>
                    </div>
                </div>
                ` : ''}
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Action Taken:</strong></p>
                        <p>${caseItem.actionTaken || 'No action taken yet'}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Customer Comment:</strong></p>
                        <p>${caseItem.customerComment || 'No customer comment'}</p>
                    </div>
                </div>
                ${caseItem.supportingFile ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Supporting File:</strong></p>
                        <a href="${caseItem.supportingFile}" target="_blank" class="btn btn-sm btn-outline-primary">View File</a>
                    </div>
                </div>
                ` : ''}
            `;
            
            AppState.currentEditingCaseId = caseId;
            modal.show();
        }

        // Edit case
        function editCase(caseId) {
            const caseItem = AppState.compensationCases.find(c => c.id === caseId);
            if (!caseItem) {
                showToast('Case not found', 'warning');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('editCaseModal'));
            const form = document.getElementById('editCaseForm');
            
            form.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editCaseId" class="form-label">Case ID</label>
                        <input type="text" class="form-control" id="editCaseId" value="${caseItem.id}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editDate" class="form-label">Date of Incident <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="editDate" value="${caseItem.date}" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editChannel" class="form-label">Channel <span class="text-danger">*</span></label>
                        <select class="form-select" id="editChannel" required>
                            <option value="">Select Channel</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editPlatform" class="form-label">Platform <span class="text-danger">*</span></label>
                        <select class="form-select" id="editPlatform" required>
                            <option value="">Select Platform</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editBranch" class="form-label">Branch <span class="text-danger">*</span></label>
                        <select class="form-select" id="editBranch" required>
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editOrderNumber" class="form-label">Order Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editOrderNumber" value="${caseItem.orderNumber}" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editCustomerName" class="form-label">Customer Name / Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editCustomerName" value="${caseItem.customerName}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editIssueType" class="form-label">Issue Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="editIssueType" required>
                            <option value="">Select Issue Type</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editResponsibleParty" class="form-label">Responsible Party <span class="text-danger">*</span></label>
                        <select class="form-select" id="editResponsibleParty" required>
                            <option value="">Select Responsible Party</option>
                            <option value="Platform" ${caseItem.responsibleParty === 'Platform' ? 'selected' : ''}>Platform</option>
                            <option value="Restaurant" ${caseItem.responsibleParty === 'Restaurant' ? 'selected' : ''}>Restaurant</option>
                            <option value="Driver" ${caseItem.responsibleParty === 'Driver' ? 'selected' : ''}>Driver</option>
                            <option value="Call Center" ${caseItem.responsibleParty === 'Call Center' ? 'selected' : ''}>Call Center</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editAgentName" class="form-label">Agent Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editAgentName" value="${caseItem.agentName}" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editOrderValue" class="form-label">Order Value (AED) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="editOrderValue" value="${caseItem.orderValue}" min="0" step="0.01" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editCompensationValue" class="form-label">Compensation Value (AED) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="editCompensationValue" value="${caseItem.compensationValue}" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editStatus" class="form-label">Status <span class="text-danger">*</span></label>
                        <select class="form-select" id="editStatus" required>
                            <option value="Open" ${caseItem.status === 'Open' ? 'selected' : ''}>Open</option>
                            <option value="Pending" ${caseItem.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Manager Review" ${caseItem.status === 'Manager Review' ? 'selected' : ''}>Manager Review</option>
                            <option value="Approved" ${caseItem.status === 'Approved' ? 'selected' : ''}>Approved</option>
                            <option value="Rejected" ${caseItem.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                            <option value="Closed" ${caseItem.status === 'Closed' ? 'selected' : ''}>Closed</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editCallReference" class="form-label">Call Reference (if applicable)</label>
                        <input type="text" class="form-control" id="editCallReference" value="${caseItem.callReference || ''}" placeholder="Enter call reference number">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="editActionTaken" class="form-label">Action Taken</label>
                        <textarea class="form-control" id="editActionTaken" rows="3">${caseItem.actionTaken || ''}</textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="editCustomerComment" class="form-label">Customer Comment</label>
                        <textarea class="form-control" id="editCustomerComment" rows="3">${caseItem.customerComment || ''}</textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="editSupportingFile" class="form-label">Supporting File / Screenshot</label>
                        <input type="text" class="form-control" id="editSupportingFile" value="${caseItem.supportingFile || ''}" placeholder="Enter file path or URL">
                    </div>
                </div>
            `;
            
            // Populate dynamic selects
            setTimeout(() => {
                // Update channel select
                const editChannelSelect = document.getElementById('editChannel');
                if (editChannelSelect) {
                    [...AppState.channels.platform, ...AppState.channels.callCenter, ...AppState.channels.online].forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel;
                        option.textContent = channel;
                        if (channel === caseItem.channel) option.selected = true;
                        editChannelSelect.appendChild(option);
                    });
                }
                
                // Update platform select
                const editPlatformSelect = document.getElementById('editPlatform');
                if (editPlatformSelect) {
                    AppState.channels.platform.forEach(platform => {
                        const option = document.createElement('option');
                        option.value = platform;
                        option.textContent = platform;
                        if (platform === caseItem.platform) option.selected = true;
                        editPlatformSelect.appendChild(option);
                    });
                }
                
                // Update branch select
                const editBranchSelect = document.getElementById('editBranch');
                if (editBranchSelect) {
                    AppState.branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.textContent = branch;
                        if (branch === caseItem.branch) option.selected = true;
                        editBranchSelect.appendChild(option);
                    });
                }
                
                // Update issue type select
                const editIssueTypeSelect = document.getElementById('editIssueType');
                if (editIssueTypeSelect) {
                    AppState.issueTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        if (type === caseItem.issueType) option.selected = true;
                        editIssueTypeSelect.appendChild(option);
                    });
                }
            }, 100);
            
            AppState.currentEditingCaseId = caseId;
            
            // Close details modal if open
            const detailsModal = bootstrap.Modal.getInstance(document.getElementById('caseDetailsModal'));
            if (detailsModal) {
                detailsModal.hide();
            }
            
            modal.show();
        }

        // Save case changes
        function saveCaseChanges() {
            if (!validateForm('editCaseForm')) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            const caseIndex = AppState.compensationCases.findIndex(c => c.id === AppState.currentEditingCaseId);
            if (caseIndex === -1) {
                showToast('Case not found', 'danger');
                return;
            }
            
            const originalStatus = AppState.compensationCases[caseIndex].status;
            const newStatus = document.getElementById('editStatus').value;
            
            AppState.compensationCases[caseIndex] = {
                ...AppState.compensationCases[caseIndex],
                date: document.getElementById('editDate').value,
                channel: document.getElementById('editChannel').value,
                platform: document.getElementById('editPlatform').value,
                branch: document.getElementById('editBranch').value,
                orderNumber: Utils.sanitizeInput(document.getElementById('editOrderNumber').value),
                customerName: Utils.sanitizeInput(document.getElementById('editCustomerName').value),
                issueType: document.getElementById('editIssueType').value,
                orderValue: parseFloat(document.getElementById('editOrderValue').value),
                compensationValue: parseFloat(document.getElementById('editCompensationValue').value),
                responsibleParty: document.getElementById('editResponsibleParty').value,
                status: newStatus,
                actionTaken: Utils.sanitizeInput(document.getElementById('editActionTaken').value),
                agentName: Utils.sanitizeInput(document.getElementById('editAgentName').value),
                callReference: Utils.sanitizeInput(document.getElementById('editCallReference').value),
                supportingFile: Utils.sanitizeInput(document.getElementById('editSupportingFile').value),
                customerComment: Utils.sanitizeInput(document.getElementById('editCustomerComment').value),
                dateClosed: (originalStatus !== 'Closed' && newStatus === 'Closed') ? new Date().toISOString() : AppState.compensationCases[caseIndex].dateClosed,
                updatedAt: new Date().toISOString()
            };
            
            if (!Utils.storage.set('compensationCases', AppState.compensationCases)) {
                return;
            }
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editCaseModal')).hide();
            
            // Update UI
            loadCases();
            updateDashboard();
            updateLastUpdated();
            updateWhatsAppCaseSelect();
            updateChannelPerformanceTable();
            
            showToast('Case updated successfully!', 'success');
        }

        // Delete case
        function deleteCase(caseId) {
            if (!confirm('Are you sure you want to delete this case? This action cannot be undone.')) {
                return;
            }
            
            AppState.compensationCases = AppState.compensationCases.filter(c => c.id !== caseId);
            
            if (!Utils.storage.set('compensationCases', AppState.compensationCases)) {
                return;
            }
            
            // Update UI
            loadCases();
            updateDashboard();
            updateLastUpdated();
            updateWhatsAppCaseSelect();
            updateChannelPerformanceTable();
            
            showToast('Case deleted successfully!', 'success');
        }

        // Apply filters
        function applyFilters() {
            const channel = document.getElementById('filterChannel').value;
            const platform = document.getElementById('filterPlatform').value;
            const branch = document.getElementById('filterBranch').value;
            const status = document.getElementById('filterStatus').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            AppState.filteredCases = AppState.compensationCases.filter(caseItem => {
                // Channel filter
                if (channel && caseItem.channel !== channel) return false;
                
                // Platform filter
                if (platform && caseItem.platform !== platform) return false;
                
                // Branch filter
                if (branch && caseItem.branch !== branch) return false;
                
                // Status filter
                if (status && caseItem.status !== status) return false;
                
                // Search filter
                if (search) {
                    const searchableText = `${caseItem.id} ${caseItem.orderNumber} ${caseItem.customerName}`.toLowerCase();
                    if (!searchableText.includes(search)) return false;
                }
                
                // Date range filter
                if (dateFrom && caseItem.date < dateFrom) return false;
                if (dateTo && caseItem.date > dateTo) return false;
                
                return true;
            });
            
            loadCases(AppState.filteredCases);
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('filterChannel').value = '';
            document.getElementById('filterPlatform').value = '';
            document.getElementById('filterBranch').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            
            AppState.filteredCases = null;
            loadCases();
        }

        // Update dynamic selects
        function updateDynamicSelects() {
            // Update issue type selects
            const issueTypeSelects = ['issueType'];
            issueTypeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Issue Type</option>';
                    AppState.issueTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        if (type === currentValue) option.selected = true;
                        select.appendChild(option);
                    });
                }
            });
            
            // Update platform selects
            const platformSelects = ['platform', 'filterPlatform'];
            platformSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Platform</option>';
                    AppState.channels.platform.forEach(platform => {
                        const option = document.createElement('option');
                        option.value = platform;
                        option.textContent = platform;
                        if (platform === currentValue) option.selected = true;
                        select.appendChild(option);
                    });
                }
            });
            
            // Update branch selects
            const branchSelects = ['branch', 'filterBranch'];
            branchSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Branch</option>';
                    AppState.branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.textContent = branch;
                        if (branch === currentValue) option.selected = true;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Load settings data
        function loadSettingsData() {
            // Load issue types
            const issueTypesList = document.getElementById('issueTypesList');
            if (issueTypesList) {
                issueTypesList.innerHTML = '';
                AppState.issueTypes.forEach(type => {
                    const item = document.createElement('div');
                    item.className = 'dynamic-list-item';
                    item.innerHTML = `
                        <span>${type}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeIssueType('${type}')" aria-label="Remove ${type}">
                            <i class="bi bi-trash" aria-hidden="true"></i>
                        </button>
                    `;
                    issueTypesList.appendChild(item);
                });
            }
            
            // Load branches
            const branchesList = document.getElementById('branchesList');
            if (branchesList) {
                branchesList.innerHTML = '';
                AppState.branches.forEach(branch => {
                    const item = document.createElement('div');
                    item.className = 'dynamic-list-item';
                    item.innerHTML = `
                        <span>${branch}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeBranch('${branch}')" aria-label="Remove ${branch}">
                            <i class="bi bi-trash" aria-hidden="true"></i>
                        </button>
                    `;
                    branchesList.appendChild(item);
                });
            }
        }

        // Add issue type
        function addIssueType() {
            const input = document.getElementById('newIssueType');
            const value = Utils.sanitizeInput(input.value.trim());
            
            if (!value) {
                showToast('Please enter an issue type', 'warning');
                return;
            }
            
            if (AppState.issueTypes.includes(value)) {
                showToast('Issue type already exists', 'warning');
                return;
            }
            
            AppState.issueTypes.push(value);
            Utils.storage.set('issueTypes', AppState.issueTypes);
            
            input.value = '';
            updateDynamicSelects();
            loadSettingsData();
            
            showToast('Issue type added successfully!', 'success');
        }

        // Remove issue type
        function removeIssueType(type) {
            if (!confirm(`Are you sure you want to remove "${type}"?`)) return;
            
            // Check if any cases use this issue type
            const casesWithIssue = AppState.compensationCases.filter(c => c.issueType === type);
            if (casesWithIssue.length > 0) {
                showToast(`Cannot remove: ${casesWithIssue.length} case(s) use this issue type`, 'danger');
                return;
            }
            
            AppState.issueTypes = AppState.issueTypes.filter(t => t !== type);
            Utils.storage.set('issueTypes', AppState.issueTypes);
            
            updateDynamicSelects();
            loadSettingsData();
            
            showToast('Issue type removed successfully!', 'success');
        }

        // Add branch
        function addBranch() {
            const input = document.getElementById('newBranch');
            const value = Utils.sanitizeInput(input.value.trim());
            
            if (!value) {
                showToast('Please enter a branch name', 'warning');
                return;
            }
            
            if (AppState.branches.includes(value)) {
                showToast('Branch already exists', 'warning');
                return;
            }
            
            AppState.branches.push(value);
            Utils.storage.set('branches', AppState.branches);
            
            input.value = '';
            updateDynamicSelects();
            loadSettingsData();
            
            showToast('Branch added successfully!', 'success');
        }

        // Remove branch
        function removeBranch(branch) {
            if (!confirm(`Are you sure you want to remove "${branch}"?`)) return;
            
            // Check if any cases use this branch
            const casesWithBranch = AppState.compensationCases.filter(c => c.branch === branch);
            if (casesWithBranch.length > 0) {
                showToast(`Cannot remove: ${casesWithBranch.length} case(s) use this branch`, 'danger');
                return;
            }
            
            AppState.branches = AppState.branches.filter(b => b !== branch);
            Utils.storage.set('branches', AppState.branches);
            
            updateDynamicSelects();
            loadSettingsData();
            
            showToast('Branch removed successfully!', 'success');
        }

        // Clear all data
        function clearAllData() {
            if (!confirm('Are you sure you want to clear ALL data? This action cannot be undone.')) {
                return;
            }
            
            if (!confirm('This will delete all cases, settings, and history. Are you absolutely sure?')) {
                return;
            }
            
            Utils.storage.remove('compensationCases');
            Utils.storage.remove('whatsappHistory');
            Utils.storage.remove('managerSettings');
            Utils.storage.remove('channels');
            Utils.storage.remove('issueTypes');
            Utils.storage.remove('branches');
            
            // Reset app state
            AppState.compensationCases = [];
            AppState.whatsappHistory = [];
            AppState.channels = {
                platform: ['Noon', 'Careem', 'Smile', 'Deliveroo', 'Keita'],
                callCenter: ['Delivery Call Center', 'Customer Service Hotline'],
                online: ['Online Call Center', 'Website Chat', 'Email Support']
            };
            AppState.issueTypes = [
                'Missing Item',
                'Late Delivery',
                'Wrong Order',
                'Refund Request',
                'Double Charge',
                'Food Quality',
                'Other'
            ];
            AppState.branches = [
                'Hamdan',
                'Khaldia',
                'Shabiya 11',
                'Muroor',
                'Electra',
                'Barsha',
                'Satwa',
                'New Branch'
            ];
            
            // Reinitialize
            initializeApp();
            
            showToast('All data has been cleared', 'info');
        }

        // Reset to defaults
        function resetToDefaults() {
            if (!confirm('Reset all settings to default values? This will not delete your cases.')) {
                return;
            }
            
            // Reset settings to defaults
            AppState.managerSettings = {
                name: 'Operations Manager',
                phone: '+971501234567',
                customMessage: `Dear Manager,

Please review and approve the following compensation case:

üìã Case Details:
‚Ä¢ Case ID: {caseId}
‚Ä¢ Date: {date}
‚Ä¢ Channel: {channel}
‚Ä¢ Platform: {platform}
‚Ä¢ Branch: {branch}
‚Ä¢ Order #: {orderNumber}
‚Ä¢ Customer: {customerName}
‚Ä¢ Issue: {issueType}
‚Ä¢ Order Value: AED {orderValue}
‚Ä¢ Compensation: AED {compensationValue}
‚Ä¢ Responsible: {responsibleParty}

Action Taken: {actionTaken}

Please reply with APPROVED or REJECTED

Thank you`
            };
            
            AppState.channels = {
                platform: ['Noon', 'Careem', 'Smile', 'Deliveroo', 'Keita'],
                callCenter: ['Delivery Call Center', 'Customer Service Hotline'],
                online: ['Online Call Center', 'Website Chat', 'Email Support']
            };
            
            AppState.issueTypes = [
                'Missing Item',
                'Late Delivery',
                'Wrong Order',
                'Refund Request',
                'Double Charge',
                'Food Quality',
                'Other'
            ];
            
            AppState.branches = [
                'Hamdan',
                'Khaldia',
                'Shabiya 11',
                'Muroor',
                'Electra',
                'Barsha',
                'Satwa',
                'New Branch'
            ];
            
            // Save to storage
            Utils.storage.set('managerSettings', AppState.managerSettings);
            Utils.storage.set('channels', AppState.channels);
            Utils.storage.set('issueTypes', AppState.issueTypes);
            Utils.storage.set('branches', AppState.branches);
            
            // Update UI
            loadManagerSettings();
            updateDynamicSelects();
            loadSettingsData();
            loadChannelData();
            
            showToast('Settings reset to defaults', 'success');
        }

        // WhatsApp functions
        function loadManagerSettings() {
            document.getElementById('managerName').value = AppState.managerSettings.name;
            document.getElementById('managerPhone').value = AppState.managerSettings.phone;
            document.getElementById('customMessage').value = AppState.managerSettings.customMessage;
        }

        function saveManagerSettings() {
            const name = Utils.sanitizeInput(document.getElementById('managerName').value);
            const phone = Utils.sanitizeInput(document.getElementById('managerPhone').value);
            const customMessage = Utils.sanitizeInput(document.getElementById('customMessage').value);
            
            if (!name || !phone) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            if (!Utils.validatePhone(phone)) {
                showToast('Please enter a valid phone number with country code', 'warning');
                return;
            }
            
            AppState.managerSettings = { name, phone, customMessage };
            Utils.storage.set('managerSettings', AppState.managerSettings);
            
            showToast('Manager settings saved successfully!', 'success');
        }

        function updateWhatsAppCaseSelect() {
            const select = document.getElementById('whatsappCaseSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select a case to send</option>';
            
            AppState.compensationCases.forEach(caseItem => {
                const option = document.createElement('option');
                option.value = caseItem.id;
                option.textContent = `${caseItem.id} - ${caseItem.customerName} (${caseItem.channel})`;
                select.appendChild(option);
            });
        }

        function previewWhatsAppMessage() {
            const caseId = document.getElementById('whatsappCaseSelect').value;
            const urgency = document.getElementById('urgencyLevel').value;
            
            if (!caseId) {
                showToast('Please select a case first', 'warning');
                return;
            }
            
            const caseItem = AppState.compensationCases.find(c => c.id === caseId);
            if (!caseItem) {
                showToast('Case not found', 'danger');
                return;
            }
            
            const message = generateWhatsAppMessage(caseItem, urgency);
            
            document.getElementById('whatsappMessageContent').innerHTML = message.replace(/\n/g, '<br>');
            document.getElementById('whatsappTimestamp').textContent = new Date().toLocaleTimeString();
            document.getElementById('whatsappPreview').style.display = 'block';
            document.getElementById('sendWhatsAppMessage').style.display = 'inline-block';
        }

        function generateWhatsAppMessage(caseItem, urgency) {
            let message = AppState.managerSettings.customMessage;
            
            // Replace placeholders
            message = message.replace(/{caseId}/g, caseItem.id);
            message = message.replace(/{date}/g, Utils.formatDate(caseItem.date));
            message = message.replace(/{channel}/g, caseItem.channel);
            message = message.replace(/{platform}/g, caseItem.platform);
            message = message.replace(/{branch}/g, caseItem.branch);
            message = message.replace(/{orderNumber}/g, caseItem.orderNumber);
            message = message.replace(/{customerName}/g, caseItem.customerName);
            message = message.replace(/{issueType}/g, caseItem.issueType);
            message = message.replace(/{orderValue}/g, caseItem.orderValue.toFixed(2));
            message = message.replace(/{compensationValue}/g, caseItem.compensationValue.toFixed(2));
            message = message.replace(/{responsibleParty}/g, caseItem.responsibleParty);
            message = message.replace(/{actionTaken}/g, caseItem.actionTaken || 'No action taken yet');
            
            // Add urgency prefix
            if (urgency === 'High') {
                message = 'üî¥ HIGH PRIORITY\n\n' + message;
            } else if (urgency === 'Urgent') {
                message = 'üö® URGENT\n\n' + message;
            }
            
            return message;
        }

        function sendWhatsAppMessage() {
            const caseId = document.getElementById('whatsappCaseSelect').value;
            const urgency = document.getElementById('urgencyLevel').value;
            
            if (!caseId) {
                showToast('Please select a case first', 'warning');
                return;
            }
            
            sendCaseWhatsApp(caseId, urgency);
        }

        function sendCaseWhatsApp(caseId, urgency = 'Normal') {
            const caseItem = AppState.compensationCases.find(c => c.id === caseId);
            if (!caseItem) {
                showToast('Case not found', 'danger');
                return;
            }
            
            const message = generateWhatsAppMessage(caseItem, urgency);
            const phoneNumber = AppState.managerSettings.phone.replace(/[^\d+]/g, '');
            
            // Create WhatsApp URL
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            
            // Save to history
            const historyItem = {
                caseId: caseId,
                sentTo: AppState.managerSettings.name,
                message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
                urgency: urgency,
                status: 'Sent',
                sentTime: new Date().toISOString()
            };
            
            AppState.whatsappHistory.unshift(historyItem);
            Utils.storage.set('whatsappHistory', AppState.whatsappHistory);
            loadWhatsAppHistory();
            
            // Update case status
            const caseIndex = AppState.compensationCases.findIndex(c => c.id === caseId);
            if (caseIndex !== -1) {
                AppState.compensationCases[caseIndex].status = 'Manager Review';
                Utils.storage.set('compensationCases', AppState.compensationCases);
                loadCases();
                updateDashboard();
            }
            
            // Open WhatsApp
            window.open(whatsappUrl, '_blank');
            
            showToast('Message sent via WhatsApp successfully!', 'success');
            
            // Close modal if open
            const modal = bootstrap.Modal.getInstance(document.getElementById('caseDetailsModal'));
            if (modal) modal.hide();
            
            // Reset WhatsApp form
            document.getElementById('whatsappCaseSelect').value = '';
            document.getElementById('urgencyLevel').value = 'Normal';
            document.getElementById('whatsappPreview').style.display = 'none';
            document.getElementById('sendWhatsAppMessage').style.display = 'none';
        }

        function loadWhatsAppHistory() {
            const tbody = document.getElementById('whatsappHistoryBody');
            if (!tbody) return;
            
            if (AppState.whatsappHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No WhatsApp messages sent yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            AppState.whatsappHistory.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.caseId}</td>
                    <td>${item.sentTo}</td>
                    <td>${item.message}</td>
                    <td><span class="badge bg-${item.urgency === 'Urgent' ? 'danger' : item.urgency === 'High' ? 'warning' : 'info'}">${item.urgency}</span></td>
                    <td><span class="badge bg-success">${item.status}</span></td>
                    <td>${Utils.formatDateTime(item.sentTime)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewWhatsAppDetails('${item.caseId}', '${item.sentTime}')" aria-label="View WhatsApp details">
                            <i class="bi bi-eye" aria-hidden="true"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewWhatsAppDetails(caseId, sentTime) {
            const historyItem = AppState.whatsappHistory.find(h => h.caseId === caseId && h.sentTime === sentTime);
            if (!historyItem) return;
            
            const caseItem = AppState.compensationCases.find(c => c.id === caseId);
            if (!caseItem) return;
            
            const modal = new bootstrap.Modal(document.getElementById('caseDetailsModal'));
            const content = document.getElementById('caseDetailsContent');
            
            content.innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="bi bi-whatsapp" aria-hidden="true"></i> WhatsApp Message Details</h6>
                    <p><strong>Sent To:</strong> ${historyItem.sentTo}</p>
                    <p><strong>Phone:</strong> ${AppState.managerSettings.phone}</p>
                    <p><strong>Sent Time:</strong> ${Utils.formatDateTime(historyItem.sentTime)}</p>
                    <p><strong>Urgency:</strong> ${historyItem.urgency}</p>
                </div>
                
                <h6>Message Content:</h6>
                <div class="border p-3 bg-light">
                    <pre style="white-space: pre-wrap; font-family: inherit;">${historyItem.message}</pre>
                </div>
                
                <hr>
                
                <h6>Case Details:</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Case ID:</strong> ${caseItem.id}</p>
                        <p><strong>Date:</strong> ${Utils.formatDate(caseItem.date)}</p>
                        <p><strong>Channel:</strong> ${caseItem.channel}</p>
                        <p><strong>Platform:</strong> ${caseItem.platform}</p>
                        <p><strong>Branch:</strong> ${caseItem.branch}</p>
                        <p><strong>Order Number:</strong> ${caseItem.orderNumber}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Customer Name:</strong> ${caseItem.customerName}</p>
                        <p><strong>Issue Type:</strong> ${caseItem.issueType}</p>
                        <p><strong>Order Value:</strong> AED ${caseItem.orderValue.toFixed(2)}</p>
                        <p><strong>Compensation Value:</strong> AED ${caseItem.compensationValue.toFixed(2)}</p>
                        <p><strong>Responsible Party:</strong> ${caseItem.responsibleParty}</p>
                        <p><strong>Status:</strong> <span class="status-badge status-${caseItem.status.toLowerCase().replace(' ', '-')}">${caseItem.status}</span></p>
                    </div>
                </div>
            `;
            
            AppState.currentEditingCaseId = caseId;
            modal.show();
        }

        // Import/Export functions
        function setupDragAndDrop(uploadArea) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('dragover');
                }, false);
            });
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({ target: { files: [files[0]] } });
                }
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const fileType = file.name.split('.').pop().toLowerCase();
            if (fileType !== 'xlsx' && fileType !== 'xls') {
                showToast('Please select a valid Excel file (.xlsx or .xls)', 'danger');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        showToast('The Excel file is empty', 'warning');
                        return;
                    }
                    
                    // Process and validate data
                    AppState.importData = processImportData(jsonData);
                    
                    if (AppState.importData.length === 0) {
                        showToast('No valid data found in the Excel file', 'warning');
                        return;
                    }
                    
                    // Show preview
                    showImportPreview();
                    
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    showToast('Error reading Excel file. Please check the format.', 'danger');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processImportData(jsonData) {
            const processedData = [];
            
            jsonData.forEach((row, index) => {
                try {
                    // Map Excel columns to our data structure
                    const caseData = {
                        id: row['Case ID'] || Utils.generateId(),
                        date: formatDateForImport(row['Date']) || new Date().toISOString().split('T')[0],
                        channel: row['Channel'] || '',
                        platform: row['Platform'] || '',
                        branch: row['Branch'] || '',
                        orderNumber: String(row['Order Number'] || ''),
                        customerName: String(row['Customer Name'] || ''),
                        issueType: row['Issue Type'] || '',
                        orderValue: parseFloat(row['Order Value']) || 0,
                        compensationValue: parseFloat(row['Compensation Value']) || 0,
                        responsibleParty: row['Responsible Party'] || '',
                        status: row['Status'] || 'Open',
                        actionTaken: String(row['Action Taken'] || ''),
                        agentName: String(row['Agent Name'] || ''),
                        callReference: String(row['Call Reference'] || ''),
                        dateClosed: row['Date Closed'] || null,
                        supportingFile: String(row['Supporting File'] || ''),
                        customerComment: String(row['Customer Comment'] || ''),
                        createdAt: new Date().toISOString()
                    };
                    
                    // Validate required fields
                    if (caseData.channel && caseData.platform && caseData.branch && caseData.orderNumber && caseData.customerName) {
                        processedData.push(caseData);
                    }
                } catch (error) {
                    console.error(`Error processing row ${index + 1}:`, error);
                }
            });
            
            return processedData;
        }

        function formatDateForImport(dateValue) {
            if (!dateValue) return null;
            
            // Handle Excel date numbers
            if (typeof dateValue === 'number') {
                const excelDate = new Date((dateValue - 25569) * 86400 * 1000);
                return excelDate.toISOString().split('T')[0];
            }
            
            // Handle string dates
            const date = new Date(dateValue);
            if (isNaN(date.getTime())) return null;
            
            return date.toISOString().split('T')[0];
        }

        function showImportPreview() {
            const previewBody = document.getElementById('importPreviewBody');
            if (!previewBody) return;
            
            previewBody.innerHTML = '';
            
            const previewCount = Math.min(10, AppState.importData.length);
            for (let i = 0; i < previewCount; i++) {
                const caseData = AppState.importData[i];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${caseData.id}</td>
                    <td>${caseData.date}</td>
                    <td>${caseData.channel}</td>
                    <td>${caseData.platform}</td>
                    <td>${caseData.branch}</td>
                    <td>${caseData.orderNumber}</td>
                    <td>${caseData.customerName}</td>
                    <td>${caseData.issueType}</td>
                    <td>AED ${caseData.compensationValue.toFixed(2)}</td>
                    <td><span class="status-badge status-${caseData.status.toLowerCase().replace(' ', '-')}">${caseData.status}</span></td>
                    <td>${caseData.agentName}</td>
                `;
                previewBody.appendChild(row);
            }
            
            if (AppState.importData.length > 10) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="11" class="text-center">... and ${AppState.importData.length - 10} more records</td>`;
                previewBody.appendChild(row);
            }
            
            document.getElementById('importPreview').style.display = 'block';
            showToast(`Preview loaded: ${AppState.importData.length} cases ready to import`, 'info');
        }

        function confirmImport() {
            if (!confirm(`Are you sure you want to import ${AppState.importData.length} cases?`)) {
                return;
            }
            
            showLoadingSpinner(true);
            
            // Add imported data to existing cases
            AppState.compensationCases = [...AppState.compensationCases, ...AppState.importData];
            
            // Save to localStorage
            if (!Utils.storage.set('compensationCases', AppState.compensationCases)) {
                showLoadingSpinner(false);
                return;
            }
            
            // Update UI
            setTimeout(() => {
                loadCases();
                updateDashboard();
                updateLastUpdated();
                updateWhatsAppCaseSelect();
                updateChannelOverview();
                updateChannelPerformanceTable();
                
                showLoadingSpinner(false);
                
                // Reset import
                cancelImport();
                
                // Show success message
                showToast(`Successfully imported ${AppState.importData.length} cases!`, 'success');
                
                // Switch to dashboard tab
                const dashboardTab = new bootstrap.Tab(document.getElementById('dashboard-tab'));
                dashboardTab.show();
            }, 500);
        }

        function cancelImport() {
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('fileInput').value = '';
            AppState.importData = [];
        }

        function downloadTemplate() {
            try {
                // Create template data
                const templateData = [{
                    'Case ID': 'CC-20231201-001',
                    'Date': '2023-12-01',
                    'Channel': 'Noon',
                    'Platform': 'Noon',
                    'Branch': 'Hamdan',
                    'Order Number': 'ORD123456',
                    'Customer Name': 'John Doe',
                    'Issue Type': 'Missing Item',
                    'Order Value': 85.50,
                    'Compensation Value': 20.00,
                    'Responsible Party': 'Restaurant',
                    'Status': 'Closed',
                    'Action Taken': 'Refund processed via platform',
                    'Agent Name': 'Agent A',
                    'Call Reference': '',
                    'Date Closed': '2023-12-02',
                    'Supporting File': '',
                    'Customer Comment': 'Customer satisfied with resolution'
                }];
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(templateData);
                XLSX.utils.book_append_sheet(wb, ws, 'Compensation Cases');
                
                // Generate file name
                const fileName = `Compensation_Cases_Template_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Download file
                XLSX.writeFile(wb, fileName);
                
                showToast('Template downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error downloading template:', error);
                showToast('Error downloading template', 'danger');
            }
        }

        function exportData(filtered = false) {
            showLoadingSpinner(true);
            
            setTimeout(() => {
                try {
                    const dataToExport = filtered ? (AppState.filteredCases || AppState.compensationCases) : AppState.compensationCases;
                    
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    XLSX.utils.book_append_sheet(wb, ws, 'Compensation Cases');
                    
                    // Generate file name
                    const suffix = filtered ? 'Filtered' : 'All';
                    const fileName = `Compensation_Cases_${suffix}_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
                    
                    // Download file
                    XLSX.writeFile(wb, fileName);
                    
                    showLoadingSpinner(false);
                    showToast(`${filtered ? 'Filtered' : 'All'} data exported successfully!`, 'success');
                } catch (error) {
                    console.error('Error exporting data:', error);
                    showLoadingSpinner(false);
                    showToast('Error exporting data', 'danger');
                }
            }, 500);
        }

        // Report functions
        function handleReportPeriodChange() {
            const reportPeriod = document.getElementById('reportPeriod').value;
            const customDateRange = document.getElementById('customDateRange');
            
            if (reportPeriod === 'custom') {
                customDateRange.style.display = 'block';
                // Set default dates
                const today = new Date();
                const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                document.getElementById('reportDateFrom').value = lastMonth.toISOString().split('T')[0];
                document.getElementById('reportDateTo').value = today.toISOString().split('T')[0];
            } else {
                customDateRange.style.display = 'none';
            }
        }

        function generateReport() {
            if (!validateForm('reportForm')) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            const reportType = document.getElementById('reportType').value;
            const reportPeriod = document.getElementById('reportPeriod').value;
            
            let filteredCases = [...AppState.compensationCases];
            
            // Apply date filter based on period
            const now = new Date();
            let dateFrom, dateTo;
            
            switch (reportPeriod) {
                case 'today':
                    dateFrom = dateTo = now.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    dateFrom = weekStart.toISOString().split('T')[0];
                    dateTo = now.toISOString().split('T')[0];
                    break;
                case 'month':
                    dateFrom = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    dateTo = now.toISOString().split('T')[0];
                    break;
                case 'quarter':
                    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    dateFrom = quarterStart.toISOString().split('T')[0];
                    dateTo = now.toISOString().split('T')[0];
                    break;
                case 'year':
                    dateFrom = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
                    dateTo = now.toISOString().split('T')[0];
                    break;
                case 'custom':
                    dateFrom = document.getElementById('reportDateFrom').value;
                    dateTo = document.getElementById('reportDateTo').value;
                    break;
            }
            
            if (dateFrom) {
                filteredCases = filteredCases.filter(c => c.date >= dateFrom);
            }
            
            if (dateTo) {
                filteredCases = filteredCases.filter(c => c.date <= dateTo);
            }
            
            // Generate report content based on type
            let reportContent = '';
            
            switch (reportType) {
                case 'summary':
                    reportContent = generateSummaryReport(filteredCases, dateFrom, dateTo);
                    break;
                case 'detailed':
                    reportContent = generateDetailedReport(filteredCases, dateFrom, dateTo);
                    break;
                case 'channel':
                    reportContent = generateChannelReport(filteredCases, dateFrom, dateTo);
                    break;
                case 'platform':
                    reportContent = generatePlatformReport(filteredCases, dateFrom, dateTo);
                    break;
                case 'branch':
                    reportContent = generateBranchReport(filteredCases, dateFrom, dateTo);
                    break;
                case 'agent':
                    reportContent = generateAgentReport(filteredCases, dateFrom, dateTo);
                    break;
            }
            
            // Display report
            const reportContentEl = document.getElementById('reportContent');
            if (reportContentEl) {
                reportContentEl.innerHTML = reportContent;
            }
            
            const reportPreview = document.getElementById('reportPreview');
            if (reportPreview) {
                reportPreview.style.display = 'block';
            }
            
            // Enable export buttons
            document.getElementById('exportExcel').disabled = false;
            document.getElementById('exportPDF').disabled = false;
            
            // Store current report data for export
            AppState.currentReportData = {
                type: reportType,
                data: filteredCases,
                dateFrom,
                dateTo
            };
            
            showToast('Report generated successfully!', 'success');
        }

        function generateSummaryReport(cases, dateFrom, dateTo) {
            const totalCases = cases.length;
            const totalCompensation = cases.reduce((sum, c) => sum + c.compensationValue, 0);
            const openCases = cases.filter(c => c.status === 'Open').length;
            const closedCases = cases.filter(c => c.status === 'Closed').length;
            const resolutionRate = totalCases > 0 ? ((closedCases / totalCases) * 100).toFixed(1) : 0;
            
            const channelCounts = {};
            const platformCounts = {};
            const branchCounts = {};
            const issueTypeCounts = {};
            
            cases.forEach(c => {
                channelCounts[c.channel] = (channelCounts[c.channel] || 0) + 1;
                platformCounts[c.platform] = (platformCounts[c.platform] || 0) + 1;
                branchCounts[c.branch] = (branchCounts[c.branch] || 0) + 1;
                issueTypeCounts[c.issueType] = (issueTypeCounts[c.issueType] || 0) + 1;
            });
            
            return `
                <div class="print-only">
                    <h2>Crispy Chicken - Compensation Summary Report</h2>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    <p>Period: ${Utils.formatDate(dateFrom)} to ${Utils.formatDate(dateTo)}</p>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h5 class="card-title">Total Cases</h5>
                                <h2 class="text-primary">${totalCases}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h5 class="card-title">Total Compensation</h5>
                                <h2 class="text-success">AED ${totalCompensation.toFixed(2)}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h5 class="card-title">Open Cases</h5>
                                <h2 class="text-warning">${openCases}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h5 class="card-title">Resolution Rate</h5>
                                <h2 class="text-info">${resolutionRate}%</h2>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-3">
                        <h5>Cases by Channel</h5>
                        <ul class="list-group">
                            ${Object.entries(channelCounts).map(([channel, count]) => 
                                `<li class="list-group-item d-flex justify-content-between">
                                    <span>${channel}</span>
                                    <span class="badge bg-primary rounded-pill">${count}</span>
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                    <div class="col-md-3">
                        <h5>Cases by Platform</h5>
                        <ul class="list-group">
                            ${Object.entries(platformCounts).map(([platform, count]) => 
                                `<li class="list-group-item d-flex justify-content-between">
                                    <span>${platform}</span>
                                    <span class="badge bg-primary rounded-pill">${count}</span>
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                    <div class="col-md-3">
                        <h5>Cases by Branch</h5>
                        <ul class="list-group">
                            ${Object.entries(branchCounts).map(([branch, count]) => 
                                `<li class="list-group-item d-flex justify-content-between">
                                    <span>${branch}</span>
                                    <span class="badge bg-primary rounded-pill">${count}</span>
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                    <div class="col-md-3">
                        <h5>Top Issue Types</h5>
                        <ul class="list-group">
                            ${Object.entries(issueTypeCounts)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 5)
                                .map(([issue, count]) => 
                                    `<li class="list-group-item d-flex justify-content-between">
                                        <span>${issue}</span>
                                        <span class="badge bg-primary rounded-pill">${count}</span>
                                    </li>`
                                ).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        function generateDetailedReport(cases, dateFrom, dateTo) {
            return `
                <div class="print-only">
                    <h2>Crispy Chicken - Detailed Compensation Report</h2>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    <p>Period: ${Utils.formatDate(dateFrom)} to ${Utils.formatDate(dateTo)}</p>
                </div>
                
                <div class="table-responsive mt-4">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Case ID</th>
                                <th>Date</th>
                                <th>Channel</th>
                                <th>Platform</th>
                                <th>Branch</th>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Issue Type</th>
                                <th>Compensation</th>
                                <th>Status</th>
                                <th>Agent</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cases.map(c => {
                                const channelType = Utils.getChannelType(c.channel);
                                const channelBadgeClass = channelType === 'platform' ? 'channel-platform' : 
                                                         channelType === 'callCenter' ? 'channel-call' : 'channel-online';
                                return `
                                <tr>
                                    <td>${c.id}</td>
                                    <td>${Utils.formatDate(c.date)}</td>
                                    <td><span class="channel-badge ${channelBadgeClass}">${c.channel}</span></td>
                                    <td>${c.platform}</td>
                                    <td>${c.branch}</td>
                                    <td>${c.orderNumber}</td>
                                    <td>${c.customerName}</td>
                                    <td>${c.issueType}</td>
                                    <td>AED ${c.compensationValue.toFixed(2)}</td>
                                    <td><span class="status-badge status-${c.status.toLowerCase().replace(' ', '-')}">${c.status}</span></td>
                                    <td>${c.agentName}</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generateChannelReport(cases, dateFrom, dateTo) {
            const channelData = {};
            
            cases.forEach(c => {
                if (!channelData[c.channel]) {
                    channelData[c.channel] = {
                        cases: 0,
                        compensation: 0,
                        openCases: 0,
                        closedCases: 0
                    };
                }
                
                channelData[c.channel].cases++;
                channelData[c.channel].compensation += c.compensationValue;
                
                if (c.status === 'Open') {
                    channelData[c.channel].openCases++;
                } else if (c.status === 'Closed') {
                    channelData[c.channel].closedCases++;
                }
            });
            
            return `
                <div class="print-only">
                    <h2>Crispy Chicken - Channel Performance Report</h2>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    <p>Period: ${Utils.formatDate(dateFrom)} to ${Utils.formatDate(dateTo)}</p>
                </div>
                
                <div class="table-responsive mt-4">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Channel</th>
                                <th>Type</th>
                                <th>Total Cases</th>
                                <th>Total Compensation</th>
                                <th>Open Cases</th>
                                <th>Closed Cases</th>
                                <th>Resolution Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(channelData).map(([channel, data]) => {
                                const channelType = Utils.getChannelType(channel);
                                const resolutionRate = data.cases > 0 
                                    ? ((data.closedCases / data.cases) * 100).toFixed(1) 
                                    : 0;
                                
                                const channelBadgeClass = channelType === 'platform' ? 'channel-platform' : 
                                                         channelType === 'callCenter' ? 'channel-call' : 'channel-online';
                                
                                return `
                                    <tr>
                                        <td><span class="channel-badge ${channelBadgeClass}">${channel}</span></td>
                                        <td>${channelType.charAt(0).toUpperCase() + channelType.slice(1)}</td>
                                        <td>${data.cases}</td>
                                        <td>AED ${data.compensation.toFixed(2)}</td>
                                        <td>${data.openCases}</td>
                                        <td>${data.closedCases}</td>
                                        <td>${resolutionRate}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generatePlatformReport(cases, dateFrom, dateTo) {
            const platformData = {};
            
            cases.forEach(c => {
                if (!platformData[c.platform]) {
                    platformData[c.platform] = {
                        cases: 0,
                        compensation: 0,
                        openCases: 0,
                        closedCases: 0
                    };
                }
                
                platformData[c.platform].cases++;
                platformData[c.platform].compensation += c.compensationValue;
                
                if (c.status === 'Open') {
                    platformData[c.platform].openCases++;
                } else if (c.status === 'Closed') {
                    platformData[c.platform].closedCases++;
                }
            });
            
            return `
                <div class="print-only">
                    <h2>Crispy Chicken - Platform Performance Report</h2>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    <p>Period: ${Utils.formatDate(dateFrom)} to ${Utils.formatDate(dateTo)}</p>
                </div>
                
                <div class="table-responsive mt-4">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Platform</th>
                                <th>Total Cases</th>
                                <th>Total Compensation</th>
                                <th>Open Cases</th>
                                <th>Closed Cases</th>
                                <th>Resolution Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(platformData).map(([platform, data]) => {
                                const resolutionRate = data.cases > 0 
                                    ? ((data.closedCases / data.cases) * 100).toFixed(1) 
                                    : 0;
                                
                                return `
                                    <tr>
                                        <td>${platform}</td>
                                        <td>${data.cases}</td>
                                        <td>AED ${data.compensation.toFixed(2)}</td>
                                        <td>${data.openCases}</td>
                                        <td>${data.closedCases}</td>
                                        <td>${resolutionRate}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generateBranchReport(cases, dateFrom, dateTo) {
            const branchData = {};
            
            cases.forEach(c => {
                if (!branchData[c.branch]) {
                    branchData[c.branch] = {
                        cases: 0,
                        compensation: 0,
                        openCases: 0,
                        closedCases: 0
                    };
                }
                
                branchData[c.branch].cases++;
                branchData[c.branch].compensation += c.compensationValue;
                
                if (c.status === 'Open') {
                    branchData[c.branch].openCases++;
                } else if (c.status === 'Closed') {
                    branchData[c.branch].closedCases++;
                }
            });
            
            return `
                <div class="print-only">
                    <h2>Crispy Chicken - Branch Performance Report</h2>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    <p>Period: ${Utils.formatDate(dateFrom)} to ${Utils.formatDate(dateTo)}</p>
                </div>
                
                <div class="table-responsive mt-4">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Branch</th>
                                <th>Total Cases</th>
                                <th>Total Compensation</th>
                                <th>Open Cases</th>
                                <th>Closed Cases</th>
                                <th>Resolution Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(branchData).map(([branch, data]) => {
                                const resolutionRate = data.cases > 0 
                                    ? ((data.closedCases / data.cases) * 100).toFixed(1) 
                                    : 0;
                                
                                return `
                                    <tr>
                                        <td>${branch}</td>
                                        <td>${data.cases}</td>
                                        <td>AED ${data.compensation.toFixed(2)}</td>
                                        <td>${data.openCases}</td>
                                        <td>${data.closedCases}</td>
                                        <td>${resolutionRate}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generateAgentReport(cases, dateFrom, dateTo) {
            const agentData = {};
            
            cases.forEach(c => {
                if (!agentData[c.agentName]) {
                    agentData[c.agentName] = {
                        casesHandled: 0,
                        compensation: 0,
                        openCases: 0,
                        closedCases: 0,
                        totalResolutionTime: 0
                    };
                }
                
                agentData[c.agentName].casesHandled++;
                agentData[c.agentName].compensation += c.compensationValue;
                
                if (c.status === 'Open') {
                    agentData[c.agentName].openCases++;
                } else if (c.status === 'Closed') {
                    agentData[c.agentName].closedCases++;
                    
                    if (c.dateClosed) {
                        const createdDate = new Date(c.createdAt);
                        const closedDate = new Date(c.dateClosed);
                        const resolutionTime = Math.floor((closedDate - createdDate) / (1000 * 60 * 60 * 24)); // in days
                        
                        agentData[c.agentName].totalResolutionTime += resolutionTime;
                    }
                }
            });
            
            return `
                <div class="print-only">
                    <h2>Crispy Chicken - Agent Performance Report</h2>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    <p>Period: ${Utils.formatDate(dateFrom)} to ${Utils.formatDate(dateTo)}</p>
                </div>
                
                <div class="table-responsive mt-4">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>Cases Handled</th>
                                <th>Total Compensation</th>
                                <th>Open Cases</th>
                                <th>Closed Cases</th>
                                <th>Resolution Rate</th>
                                <th>Avg. Resolution Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(agentData).map(([agent, data]) => {
                                const resolutionRate = data.casesHandled > 0 
                                    ? ((data.closedCases / data.casesHandled) * 100).toFixed(1) 
                                    : 0;
                                
                                const avgResolutionTime = data.closedCases > 0 
                                    ? (data.totalResolutionTime / data.closedCases).toFixed(1) 
                                    : 0;
                                
                                return `
                                    <tr>
                                        <td>${agent}</td>
                                        <td>${data.casesHandled}</td>
                                        <td>AED ${data.compensation.toFixed(2)}</td>
                                        <td>${data.openCases}</td>
                                        <td>${data.closedCases}</td>
                                        <td>${resolutionRate}%</td>
                                        <td>${avgResolutionTime} days</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function exportReport(format) {
            if (!AppState.currentReportData) {
                showToast('No report data to export', 'warning');
                return;
            }
            
            if (format === 'excel') {
                exportReportToExcel();
            } else if (format === 'pdf') {
                exportReportToPDF();
            }
        }

        function exportReportToExcel() {
            showLoadingSpinner(true);
            
            setTimeout(() => {
                try {
                    const { data, dateFrom, dateTo } = AppState.currentReportData;
                    
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(data);
                    XLSX.utils.book_append_sheet(wb, ws, 'Report Data');
                    
                    // Generate file name
                    const fileName = `Report_${AppState.currentReportData.type}_${dateFrom}_to_${dateTo}.xlsx`;
                    
                    // Download file
                    XLSX.writeFile(wb, fileName);
                    
                    showLoadingSpinner(false);
                    showToast('Report exported to Excel successfully!', 'success');
                } catch (error) {
                    console.error('Error exporting report:', error);
                    showLoadingSpinner(false);
                    showToast('Error exporting report', 'danger');
                }
            }, 500);
        }

        function exportReportToPDF() {
            // This is a simplified version - in a real implementation, you would use a library like jsPDF
            const reportContent = document.getElementById('reportContent').innerHTML;
            
            if (!reportContent) {
                showToast('No report content to export', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>Crispy Chicken - Compensation Report</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .table { width: 100%; border-collapse: collapse; }
                            .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            .table th { background-color: #f2f2f2; }
                            .stat-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
                            .no-print { display: none !important; }
                            @media print { body { margin: 10px; } }
                        </style>
                    </head>
                    <body>
                        ${reportContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            showToast('PDF export initiated', 'success');
        }

        function printReport() {
            window.print();
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            const formattedTime = now.toLocaleString();
            
            const lastUpdatedEl = document.getElementById('lastUpdated');
            if (lastUpdatedEl) {
                lastUpdatedEl.textContent = `Last Updated: ${formattedTime}`;
            }
            
            const footerLastUpdatedEl = document.getElementById('footerLastUpdated');
            if (footerLastUpdatedEl) {
                footerLastUpdatedEl.textContent = formattedTime;
            }
        }
    </script>
</body>
</html>
